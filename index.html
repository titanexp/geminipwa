はい、承知いたしました。ご要望に基づき、提案されたセキュリティ対策を適用し、コメントを削除した完全なコードを以下に示します。バージョンは現状の `0.26ti` のままです。

DOMPurifyライブラリはCDN経由で読み込むように `<head>` に追加し、CSP（Content Security Policy）も `<meta>` タグで設定します。URL妥当性検証関数とサービスワーカーの更新ロジックも実装しました。

```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeminiPWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" id="theme-color-meta" content="#4a90e2">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdnjs.cloudflare.com; script-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; object-src 'none'; frame-ancestors 'none'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; connect-src 'self' https://generativelanguage.googleapis.com https://api.deepseek.com;">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --bg-tertiary: #fdfdfd;
            --bg-tertiary-rgb: 253, 253, 253;
            --bg-input: #ffffff;
            --bg-user-message: #dcf8c6;
            --bg-model-message: #e5e5ea;
            --bg-system-message: #f0f8ff;
            --bg-error-message: #ffebee;
            --bg-button: #4a90e2;
            --bg-button-hover: #357abd;
            --bg-button-disabled: #a0c3e8;
            --bg-button-action: #777777;
            --bg-button-action-hover: #555555;
            --bg-button-delete: #e53935;
            --bg-button-delete-hover: #c62828;
            --bg-button-retry: #43a047;
            --bg-button-retry-hover: #2e7d32;
            --bg-button-edit: #ff9800;
            --bg-button-edit-hover: #f57c00;
            --bg-button-copy: #e91e63;
            --bg-button-copy-hover: #c2185b;
            --bg-button-paste: #00bcd4;
            --bg-button-paste-hover: #0097a7;
            --bg-button-duplicate: #546e7a;
            --bg-button-duplicate-hover: #37474f;
            --bg-button-export: #1e88e5;
            --bg-button-export-hover: #1565c0;
            --bg-button-save: #30d158;
            --bg-button-save-hover: #24a345;
            --bg-button-cancel: #f44336;
            --bg-button-cancel-hover: #d32f2f;
            --bg-button-update: #1976d2;
            --bg-button-update-hover: #115293;
            --bg-header: #4a90e2;
            --overlay-base-rgb: 255, 255, 255;
            --chat-overlay-alpha: 0.65;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: #e53935;
            --bg-button-header-delete-hover: #c62828;
            --bg-button-header-copy: #e91e63;
            --bg-button-header-copy-hover: #c2185b;
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);


            --text-primary: #333333;
            --text-secondary: #777777;
            --text-light: #ffffff;
            --text-disabled: #e0e0e0;
            --text-error: #c62828;
            --text-link: #4a90e2;
            --text-placeholder: #999999;
            --text-system: #555;
            --text-memo: #000000;
            --bg-memo: #ffffff;


            --border-primary: #cccccc;
            --border-secondary: #dddddd;
            --border-tertiary: #eeeeee;
            --border-danger: #ffcdd2;
            --border-system: #add8e6;

            --shadow-primary: rgba(0, 0, 0, 0.1);
            --shadow-secondary: rgba(0,0,0,0.1);

            --message-max-width: 85%;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --message-body-font-size: 14px;
            --code-block-font-size: 13px;
            --chat-background-image: none;

            --bg-dialog-file-item: var(--bg-tertiary);
            --border-dialog-file-item: var(--border-secondary);
            --text-dialog-file-name: var(--text-primary);
            --text-dialog-file-size: var(--text-secondary);
            --bg-dialog-button-select: var(--bg-button-action);
            --bg-dialog-button-select-hover: var(--bg-button-action-hover);
            --bg-dialog-button-confirm: var(--bg-button-save);
            --bg-dialog-button-confirm-hover: var(--bg-button-save-hover);
            --bg-dialog-button-cancel: var(--bg-button-cancel);
            --bg-dialog-button-cancel-hover: var(--bg-button-cancel-hover);

            --bg-attachment-details: rgba(0, 0, 0, 0.03);
            --border-attachment-details: var(--border-tertiary);
            --text-attachment-summary: var(--text-secondary);
            --text-attachment-filename: var(--text-primary);

            --badge-color: #ffcc00;
            --badge-size: 12px;

            --memo-height: 300px;
            --clipboard-stack-height: 300px;
            --message-icon-size: 28px;
            --message-icon-offset-y: -10px;
            --icon-name-font-size: 10px;
            --icon-name-offset-y: -10px;

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --message-bubble-opacity: 1;
            --header-footer-opacity: 1;

            --bg-button-gold: #FFD700;
            --bg-button-gold-hover: #FFC700;
            --text-button-gold: #ffffff;
            --bg-button-purple: #800080;
            --bg-button-purple-hover: #6A006A;
            --text-button-purple: #ffffff;

            --message-toggle-button-top-width: 6px;
            --message-toggle-button-top-height: 40px;
            --message-toggle-button-top-font-size: 12px;
            --message-toggle-button-top-opacity: 0.6;
            --message-toggle-button-top-text-collapse: "-";
            --message-toggle-button-top-text-expand: "□";

            --message-toggle-button-bottom-font-size: 14px;
            --message-toggle-button-bottom-text-collapse: "非表示";
            --message-toggle-button-bottom-text-expand: "表示";

            --message-actions-base-rgb: 255, 255, 255;
            --message-actions-bg-opacity: 0.8;

            --user-name-bubble-bg: transparent;
            --ai-name-bubble-bg: transparent;
            --user-name-bubble-padding-y: 2px;
            --user-name-bubble-padding-x-ratio: 0.5;
            --user-name-bubble-border-radius: 5px;
            --ai-name-bubble-padding-y: 2px;
            --ai-name-bubble-padding-x-ratio: 0.5;
            --ai-name-bubble-border-radius: 5px;
            --default-user-name-bubble-custom-rgb: 255, 255, 255;
            --default-ai-name-bubble-custom-rgb: 255, 255, 255;

            --thought-summary-opacity: 0.85;
            --thought-summary-font-size: 13px;
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #101010;
            --bg-tertiary: #252525;
            --bg-tertiary-rgb: 37, 37, 37;
            --bg-input: #303030;
            --bg-user-message: #056162;
            --bg-model-message: #3a3a3c;
            --bg-system-message: #2a3a4a;
            --bg-error-message: #5c1c1c;
            --bg-button: #007aff;
            --bg-button-hover: #005ecb;
            --bg-button-disabled: #4a5a70;
            --bg-button-action: #666666;
            --bg-button-action-hover: #888888;
            --bg-button-delete: #ff3b30;
            --bg-button-delete-hover: #d12c23;
            --bg-button-retry: #34c759;
            --bg-button-retry-hover: #249a41;
            --bg-button-edit: #ff9500;
            --bg-button-edit-hover: #d17d00;
            --bg-button-copy: #f06292;
            --bg-button-copy-hover: #ec407a;
            --bg-button-paste: #4dd0e1;
            --bg-button-paste-hover: #26c6da;
            --bg-button-duplicate: #8e8e93;
            --bg-button-duplicate-hover: #6b6b70;
            --bg-button-export: #0a84ff;
            --bg-button-export-hover: #0069d1;
            --bg-button-save: #30d158;
            --bg-button-save-hover: #24a345;
            --bg-button-cancel: #ff453a;
            --bg-button-cancel-hover: #d1332b;
            --bg-button-update: #0a84ff;
            --bg-button-update-hover: #0069d1;
            --bg-header: #007aff;
            --overlay-base-rgb: 30, 30, 30;
            --bg-memo: #2c2c2e;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #e0e0e0;
            --text-secondary: #aaaaaa;
            --text-light: #ffffff;
            --text-disabled: #666666;
            --text-error: #ff8a80;
            --text-link: #00aaff;
            --text-placeholder: #777777;
            --text-system: #ccc;
            --text-memo: #e0e0e0;

            --border-primary: #444444;
            --border-secondary: #555555;
            --border-tertiary: #333333;
            --border-danger: #7a2e35;
            --border-system: #4682b4;

            --shadow-primary: rgba(255, 255, 255, 0.1);
            --shadow-secondary: rgba(0, 0, 0, 0.5);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: #b8860b;
            --bg-button-gold-hover: #daa520;
            --text-button-gold: #ffffff;
            --bg-button-purple: #6a0dad;
            --bg-button-purple-hover: #8a2be2;
            --text-button-purple: #ffffff;

            --message-actions-base-rgb: 50, 50, 50;
            --default-user-name-bubble-custom-rgb: 50, 50, 50;
            --default-ai-name-bubble-custom-rgb: 50, 50, 50;
        }


        body.pastel-pink-mode {
            --bg-primary: #fff5f8;
            --bg-secondary: #ffe6ea;
            --bg-tertiary: #fff0f3;
            --bg-tertiary-rgb: 255, 240, 243;
            --bg-input: #ffffff;
            --bg-user-message: #ffddee;
            --bg-model-message: #f3e8ff;
            --bg-system-message: #ffeef2;
            --bg-error-message: #ffccd5;
            --bg-button: #ff8fab;
            --bg-button-hover: #ff7096;
            --bg-button-disabled: #fcc2d7;
            --bg-button-action: #ffb3c1;
            --bg-button-action-hover: #ffa8b9;
            --bg-button-delete: #ff6b6b;
            --bg-button-delete-hover: #f06060;
            --bg-button-retry: #a0eade;
            --bg-button-retry-hover: #88d8c0;
            --bg-button-edit: #ffc974;
            --bg-button-edit-hover: #ffbd59;
            --bg-button-copy: #e5a9f0;
            --bg-button-copy-hover: #d998e3;
            --bg-button-paste: #b2e0ff;
            --bg-button-paste-hover: #a1d5f7;
            --bg-button-duplicate: #ffdaab;
            --bg-button-duplicate-hover: #ffce96;
            --bg-button-export: #c8a2c8;
            --bg-button-export-hover: #b991b9;
            --bg-button-save: #90ee90;
            --bg-button-save-hover: #78dd78;
            --bg-button-cancel: #ff9aa2;
            --bg-button-cancel-hover: #ff868e;
            --bg-button-update: #ff9a8b;
            --bg-button-update-hover: #ff8773;
            --bg-header: #ff8fab;
            --overlay-base-rgb: 255, 245, 248;
            --bg-memo: #fffafb;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #5c3c45;
            --text-secondary: #8c6b74;
            --text-light: #ffffff;
            --text-disabled: #d8b8c0;
            --text-error: #c5002f;
            --text-link: #ff69b4;
            --text-placeholder: #b28a94;
            --text-system: #7d5a65;
            --text-memo: #5c3c45;

            --border-primary: #ffc2d7;
            --border-secondary: #ffe0e7;
            --border-tertiary: #fff0f3;
            --border-danger: #ffb3c1;
            --border-system: #ffd1dc;

            --shadow-primary: rgba(200, 150, 160, 0.1);
            --shadow-secondary: rgba(200, 150, 160, 0.1);

            --bg-dialog-file-item: var(--bg-tertiary);
            --border-dialog-file-item: var(--border-secondary);
            --text-dialog-file-name: var(--text-primary);
            --text-dialog-file-size: var(--text-secondary);
            --bg-dialog-button-select: var(--bg-button-action);
            --bg-dialog-button-select-hover: var(--bg-button-action-hover);
            --bg-dialog-button-confirm: var(--bg-button-save);
            --bg-dialog-button-confirm-hover: var(--bg-button-save-hover);
            --bg-dialog-button-cancel: var(--bg-button-cancel);
            --bg-dialog-button-cancel-hover: var(--bg-button-cancel-hover);

            --bg-attachment-details: rgba(255, 230, 234, 0.5);
            --border-attachment-details: var(--border-tertiary);
            --text-attachment-summary: var(--text-secondary);
            --text-attachment-filename: var(--text-primary);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: #ffdd77;
            --bg-button-gold-hover: #ffcc55;
            --text-button-gold: #816200;
            --bg-button-purple: #d9a7e0;
            --bg-button-purple-hover: #c790d0;
            --text-button-purple: #ffffff;

            --message-actions-base-rgb: 255, 230, 234;

            --default-user-name-bubble-custom-rgb: 255, 230, 234;
            --default-ai-name-bubble-custom-rgb: 255, 230, 234;
        }


        body.pastel-blue-mode {
            --bg-primary: #f0f8ff;
            --bg-secondary: #e0f0ff;
            --bg-tertiary: #eaf5ff;
            --bg-tertiary-rgb: 234, 245, 255;
            --bg-input: #ffffff;
            --bg-user-message: #cff1ef;
            --bg-model-message: #e0e8ff;
            --bg-system-message: #e6f2ff;
            --bg-error-message: #d1e9ff;
            --bg-button: #87cefa;
            --bg-button-hover: #70b8e8;
            --bg-button-disabled: #b0dfff;
            --bg-button-action: #add8e6;
            --bg-button-action-hover: #9ccce0;
            --bg-button-delete: #ff7f7f;
            --bg-button-delete-hover: #ff6a6a;
            --bg-button-retry: #98fb98;
            --bg-button-retry-hover: #82f082;
            --bg-button-edit: #ffe082;
            --bg-button-edit-hover: #ffda6b;
            --bg-button-copy: #bca0dc;
            --bg-button-copy-hover: #ae8fcf;
            --bg-button-paste: #a0cfd8;
            --bg-button-paste-hover: #8ebfc9;
            --bg-button-duplicate: #c1e1c1;
            --bg-button-duplicate-hover: #add6ad;
            --bg-button-export: #b0c4de;
            --bg-button-export-hover: #a0b7d3;
            --bg-button-save: #90ee90;
            --bg-button-save-hover: #78dd78;
            --bg-button-cancel: #ff94a0;
            --bg-button-cancel-hover: #ff808c;
            --bg-button-update: #89cff0;
            --bg-button-update-hover: #70c0e0;
            --bg-header: #87cefa;
            --overlay-base-rgb: 240, 248, 255;
            --bg-memo: #f5faff;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #3a5679;
            --text-secondary: #6b87a9;
            --text-light: #ffffff;
            --text-disabled: #aec8e1;
            --text-error: #a52a2a;
            --text-link: #5f9ea0;
            --text-placeholder: #9ab0c9;
            --text-system: #5a7698;
            --text-memo: #3a5679;


            --border-primary: #b0dfff;
            --border-secondary: #d5eaff;
            --border-tertiary: #eaf5ff;
            --border-danger: #add8e6;
            --border-system: #c1d8e8;

            --shadow-primary: rgba(150, 180, 200, 0.1);
            --shadow-secondary: rgba(150, 180, 200, 0.1);

            --bg-dialog-file-item: var(--bg-tertiary);
            --border-dialog-file-item: var(--border-secondary);
            --text-dialog-file-name: var(--text-primary);
            --text-dialog-file-size: var(--text-secondary);
            --bg-dialog-button-select: var(--bg-button-action);
            --bg-dialog-button-select-hover: var(--bg-button-action-hover);
            --bg-dialog-button-confirm: var(--bg-button-save);
            --bg-dialog-button-confirm-hover: var(--bg-button-save-hover);
            --bg-dialog-button-cancel: var(--bg-button-cancel);
            --bg-dialog-button-cancel-hover: var(--bg-button-cancel-hover);

            --bg-attachment-details: rgba(224, 240, 255, 0.5);
            --border-attachment-details: var(--border-tertiary);
            --text-attachment-summary: var(--text-secondary);
            --text-attachment-filename: var(--text-primary);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: #ffe48c;
            --bg-button-gold-hover: #ffda70;
            --text-button-gold: #7a6200;
            --bg-button-purple: #c1b2d7;
            --bg-button-purple-hover: #b0a0cb;
            --text-button-purple: #ffffff;

            --message-actions-base-rgb: 224, 240, 255;

            --default-user-name-bubble-custom-rgb: 224, 240, 255;
            --default-ai-name-bubble-custom-rgb: 224, 240, 255;
        }


        body.pastel-yellow-mode {
            --bg-primary: #fffefa;
            --bg-secondary: #fffacd;
            --bg-tertiary: #fff8dc;
            --bg-tertiary-rgb: 255, 248, 220;
            --bg-input: #ffffff;
            --bg-user-message: #fff5ba;
            --bg-model-message: #ffe4b5;
            --bg-system-message: #fffbea;
            --bg-error-message: #ffebcd;
            --bg-button: #ffd700;
            --bg-button-hover: #ffc700;
            --bg-button-disabled: #fff0b3;
            --bg-button-action: #ffec8b;
            --bg-button-action-hover: #ffdf60;
            --bg-button-delete: #ffa07a;
            --bg-button-delete-hover: #ff8c69;
            --bg-button-retry: #b0e57c;
            --bg-button-retry-hover: #9acd32;
            --bg-button-edit: #ffa500;
            --bg-button-edit-hover: #ff8c00;
            --bg-button-copy: #ffb6c1;
            --bg-button-copy-hover: #ffaab5;
            --bg-button-paste: #add8e6;
            --bg-button-paste-hover: #9ccce0;
            --bg-button-duplicate: #f0e68c;
            --bg-button-duplicate-hover: #eadc67;
            --bg-button-export: #fff0b3;
            --bg-button-export-hover: #ffe78a;
            --bg-button-save: #98fb98;
            --bg-button-save-hover: #82f082;
            --bg-button-cancel: #ffdab9;
            --bg-button-cancel-hover: #ffceaa;
            --bg-button-update: #ffcc5c;
            --bg-button-update-hover: #ffbf40;
            --bg-header: #ffd700;
            --overlay-base-rgb: 255, 254, 250;
            --bg-memo: #fffef0;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);


            --text-primary: #5d4037;
            --text-secondary: #8d6e63;
            --text-light: #424242;
            --text-disabled: #bcaaa4;
            --text-error: #b71c1c;
            --text-link: #ff8f00;
            --text-placeholder: #a1887f;
            --text-system: #795548;
            --text-memo: #5d4037;

            --border-primary: #fff0b3;
            --border-secondary: #fff5ba;
            --border-tertiary: #fffacd;
            --border-danger: #ffcc80;
            --border-system: #fff9c4;

            --shadow-primary: rgba(200, 180, 130, 0.1);
            --shadow-secondary: rgba(200, 180, 130, 0.1);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: var(--bg-button);
            --bg-button-gold-hover: var(--bg-button-hover);
            --text-button-gold: var(--text-light);
            --bg-button-purple: #e6e6fa;
            --bg-button-purple-hover: #d8bfd8;
            --text-button-purple: #4b0082;

            --message-actions-base-rgb: 255, 250, 205;

            --default-user-name-bubble-custom-rgb: 255, 250, 205;
            --default-ai-name-bubble-custom-rgb: 255, 250, 205;
        }


        body.pastel-purple-mode {
            --bg-primary: #f3e5f5;
            --bg-secondary: #e1bee7;
            --bg-tertiary: #ede7f6;
            --bg-tertiary-rgb: 237, 231, 246;
            --bg-input: #ffffff;
            --bg-user-message: #d1c4e9;
            --bg-model-message: #c5cae9;
            --bg-system-message: #f3e8fd;
            --bg-error-message: #f8bbd0;
            --bg-button: #ab47bc;
            --bg-button-hover: #9c27b0;
            --bg-button-disabled: #ce93d8;
            --bg-button-action: #ba68c8;
            --bg-button-action-hover: #a54eb4;
            --bg-button-delete: #ec407a;
            --bg-button-delete-hover: #d81b60;
            --bg-button-retry: #81c784;
            --bg-button-retry-hover: #66bb6a;
            --bg-button-edit: #ffb74d;
            --bg-button-edit-hover: #ffa726;
            --bg-button-copy: #7e57c2;
            --bg-button-copy-hover: #673ab7;
            --bg-button-paste: #64b5f6;
            --bg-button-paste-hover: #42a5f5;
            --bg-button-duplicate: #9575cd;
            --bg-button-duplicate-hover: #7e57c2;
            --bg-button-export: #b39ddb;
            --bg-button-export-hover: #9d80cf;
            --bg-button-save: #a5d6a7;
            --bg-button-save-hover: #81c784;
            --bg-button-cancel: #ef9a9a;
            --bg-button-cancel-hover: #e57373;
            --bg-button-update: #7986cb;
            --bg-button-update-hover: #5c6bc0;
            --bg-header: #ab47bc;
            --overlay-base-rgb: 243, 229, 245;
            --bg-memo: #fbfaff;
            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #4a148c;
            --text-secondary: #6a1b9a;
            --text-light: #ffffff;
            --text-disabled: #b39ddb;
            --text-error: #c2185b;
            --text-link: #7b1fa2;
            --text-placeholder: #9078a0;
            --text-system: #6a1b9a;
            --text-memo: #4a148c;

            --border-primary: #ce93d8;
            --border-secondary: #e1bee7;
            --border-tertiary: #f3e5f5;
            --border-danger: #f48fb1;
            --border-system: #d1c4e9;

            --shadow-primary: rgba(170, 150, 200, 0.1);
            --shadow-secondary: rgba(170, 150, 200, 0.1);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --bg-button-gold: #ffee58;
            --bg-button-gold-hover: #fdd835;
            --text-button-gold: #424242;
            --bg-button-purple: var(--bg-button);
            --bg-button-purple-hover: var(--bg-button-hover);
            --text-button-purple: var(--text-light);

            --message-actions-base-rgb: 225, 190, 231;

            --default-user-name-bubble-custom-rgb: 225, 190, 231;
            --default-ai-name-bubble-custom-rgb: 225, 190, 231;
        }


        body.pastel-rainbow-mode {
            --bg-primary: #fdfdfd;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #fafafa;
            --bg-tertiary-rgb: 250, 250, 250;
            --bg-input: #ffffff;
            --bg-user-message: #e0fff0;
            --bg-model-message: #e0f0ff;
            --bg-system-message: #fff0f8;
            --bg-error-message: #fff8e0;
            --bg-button: #ff80c0;
            --bg-button-hover: #ff60a0;
            --bg-button-disabled: #ffc0e0;
            --bg-button-action: #80d0ff;
            --bg-button-action-hover: #60b0e0;
            --bg-button-delete: #ff8080;
            --bg-button-delete-hover: #ff6060;
            --bg-button-retry: #80ff80;
            --bg-button-retry-hover: #60e060;
            --bg-button-edit: #ffc080;
            --bg-button-edit-hover: #ffa060;
            --bg-button-copy: #c080ff;
            --bg-button-copy-hover: #a060e0;
            --bg-button-paste: #ffff80;
            --bg-button-paste-hover: #e0e060;
            --bg-button-duplicate: #80ffff;
            --bg-button-duplicate-hover: #60e0e0;
            --bg-button-export: #ff80ff;
            --bg-button-export-hover: #e060e0;
            --bg-button-save: #c0ff80;
            --bg-button-save-hover: #a0e060;
            --bg-button-cancel: #ffc0c0;
            --bg-button-cancel-hover: #ffa0a0;
            --bg-button-update: #80c0ff;
            --bg-button-update-hover: #60a0e0;
            --bg-header: linear-gradient(to right, #ffadad, #ffd6a5, #fdffb6, #caffbf, #9bf6ff, #a0c4ff, #bdb2ff, #ffc6ff, #ffadad);
            --overlay-base-rgb: 253, 253, 253;
            --bg-memo: #f0fff0;
            --bg-code-copy-button: var(--bg-button-action);
            --bg-code-copy-button-hover: var(--bg-button-action-hover);
            --text-code-copy-button: var(--text-light);

            --text-primary: #333;
            --text-secondary: #555;
            --text-light: #fff;
            --text-disabled: #aaa;
            --text-error: #c00;
            --text-link: #007bff;
            --text-placeholder: #888;
            --text-system: #444;
            --text-memo: #333;

            --border-primary: #e0e0e0;
            --border-secondary: #f0f0f0;
            --border-tertiary: #fafafa;
            --border-danger: #ffdddd;
            --border-system: #e0e8f0;

            --bg-button-gold: #ffcc00;
            --text-button-gold: #333;
            --bg-button-purple: #cc99ff;
            --text-button-purple: #fff;

            --bg-cascade-button: var(--bg-button-action);
            --bg-cascade-button-hover: var(--bg-button-action-hover);
            --bg-cascade-delete-button: var(--bg-button-delete);
            --bg-cascade-delete-button-hover: var(--bg-button-delete-hover);
            --text-cascade-indicator: var(--text-secondary);
            --bg-button-header-delete: var(--bg-button-delete);
            --bg-button-header-delete-hover: var(--bg-button-delete-hover);
            --bg-button-header-copy: var(--bg-button-copy);
            --bg-button-header-copy-hover: var(--bg-button-copy-hover);

            --bg-dialog-file-item: var(--bg-tertiary);
            --border-dialog-file-item: var(--border-secondary);
            --text-dialog-file-name: var(--text-primary);
            --text-dialog-file-size: var(--text-secondary);
            --bg-dialog-button-select: var(--bg-button-action);
            --bg-dialog-button-select-hover: var(--bg-button-action-hover);
            --bg-dialog-button-confirm: var(--bg-button-save);
            --bg-dialog-button-confirm-hover: var(--bg-button-save-hover);
            --bg-dialog-button-cancel: var(--bg-button-cancel);
            --bg-dialog-button-cancel-hover: var(--bg-button-cancel-hover);

            --bg-attachment-details: rgba(240, 240, 240, 0.5);
            --border-attachment-details: var(--border-tertiary);
            --text-attachment-summary: var(--text-secondary);
            --text-attachment-filename: var(--text-primary);

            --bg-toggle-button: var(--bg-button-action);
            --bg-toggle-button-hover: var(--bg-button-action-hover);
            --text-toggle-button: var(--text-light);

            --message-actions-base-rgb: 245, 245, 245;

            --default-user-name-bubble-custom-rgb: 245, 245, 245;
            --default-ai-name-bubble-custom-rgb: 245, 245, 245;
        }



        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            font-family: var(--font-family);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            overscroll-behavior-y: contain;
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow: hidden;
        }
        button {
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            background-color: var(--bg-button);
            color: var(--text-light);
            transition: background-color 0.2s ease, color 0.2s ease;
            line-height: 1.4;
        }
        button:hover:not(:disabled) {
            background-color: var(--bg-button-hover);
        }
        button:disabled {
            background-color: var(--bg-button-disabled);
            cursor: not-allowed;
            color: var(--text-disabled);
        }
        input[type="text"],
        input[type="password"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-primary);
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 10px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
            color: var(--text-primary);
        }
        ::placeholder { color: var(--text-placeholder); opacity: 1; }
        :-ms-input-placeholder { color: var(--text-placeholder); }
        ::-ms-input-placeholder { color: var(--text-placeholder); }
        .hidden { display: none !important; }

        .app-container {
            display: flex;
            position: relative;
            height: 100%;
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--bg-primary);
            box-shadow: 0 0 10px var(--shadow-secondary);
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        .app-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(var(--bg-header-rgb, 74, 144, 226), var(--header-footer-opacity, 1));
            color: var(--text-light);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s ease;
            gap: 8px;
        }
        body.pastel-rainbow-mode .app-header {
            background: var(--bg-header);
        }

        .app-header h1 {
            font-size: 18px;
            font-weight: bold;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            text-align: left;
            margin: 0;
            margin-right: auto;
            flex-shrink: 1;
            min-width: 60px;
        }
        .header-button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 20px;
            padding: 5px;
            line-height: 1;
            min-width: 30px;
            flex-shrink: 0;
        }
        #goto-settings-btn {
            order: 99;
            margin-left: 5px;
        }


        .app-header #toggle-clipboard-stack-btn,
        .app-header #toggle-memo-btn,
        .app-header .scroll-jump-button,
        .app-header #toggle-all-content-btn {
            background-color: transparent !important;
            color: var(--text-light);
            box-shadow: none !important;
            border: 1px solid transparent;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        .app-header #toggle-clipboard-stack-btn:hover,
        .app-header #toggle-memo-btn:hover,
        .app-header .scroll-jump-button:hover,
        .app-header #toggle-all-content-btn:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        body.pastel-yellow-mode .app-header #toggle-clipboard-stack-btn,
        body.pastel-yellow-mode .app-header #toggle-memo-btn,
        body.pastel-yellow-mode .app-header .scroll-jump-button,
        body.pastel-yellow-mode .app-header #toggle-all-content-btn {
            color: #424242;
        }
        body.pastel-yellow-mode .app-header #toggle-clipboard-stack-btn:hover,
        body.pastel-yellow-mode .app-header #toggle-memo-btn:hover,
        body.pastel-yellow-mode .app-header .scroll-jump-button:hover,
        body.pastel-yellow-mode .app-header #toggle-all-content-btn:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            border-color: rgba(0, 0, 0, 0.1) !important;
        }
        body.dark-mode .app-header #toggle-clipboard-stack-btn:hover,
        body.dark-mode .app-header #toggle-memo-btn:hover,
        body.dark-mode .app-header .scroll-jump-button:hover,
        body.dark-mode .app-header #toggle-all-content-btn:hover {
            background-color: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }


        #history-screen .app-header {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            background-color: rgba(var(--bg-header-rgb, 74, 144, 226), var(--header-footer-opacity, 1));
            color: var(--text-light);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s ease;
            gap: 10px;
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        body.pastel-rainbow-mode #history-screen .app-header {
            background: var(--bg-header);
        }

        #history-screen .app-header h1#history-title {
            font-size: 18px;
            font-weight: bold;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            text-align: right;
            margin: 0;
            margin-left: auto;
            order: 2;
        }
        #history-screen .app-header #back-to-chat-from-history {
            order: 1;
        }

        #history-screen .app-header #export-all-sessions-btn {
            order: 3;
            padding: 4px 8px;
        }
        #history-screen .app-header #import-all-sessions-btn {
            order: 4;
            padding: 4px 8px;
        }
        #history-screen .app-header #import-history-btn {
            order: 5;
            margin-right: 0;
            padding: 4px 8px;
        }

        .history-action-button.gold {
            background-color: var(--bg-button-gold);
            color: var(--text-button-gold);
        }
        .history-action-button.gold:hover:not(:disabled) {
            background-color: var(--bg-button-gold-hover);
        }
        .history-action-button.purple {
            background-color: var(--bg-button-purple);
            color: var(--text-button-purple);
        }
        .history-action-button.purple:hover:not(:disabled) {
            background-color: var(--bg-button-purple-hover);
        }
        body.dark-mode .history-action-button.gold {
            background-color: var(--bg-button-gold);
            color: var(--text-button-gold);
        }
        body.dark-mode .history-action-button.gold:hover:not(:disabled) {
            background-color: var(--bg-button-gold-hover);
        }
        body.dark-mode .history-action-button.purple {
            background-color: var(--bg-button-purple);
            color: var(--text-button-purple);
        }
        body.dark-mode .history-action-button.purple:hover:not(:disabled) {
            background-color: var(--bg-button-purple-hover);
        }
        body.pastel-pink-mode .history-action-button.gold,
        body.pastel-blue-mode .history-action-button.gold,
        body.pastel-yellow-mode .history-action-button.gold,
        body.pastel-purple-mode .history-action-button.gold,
        body.pastel-rainbow-mode .history-action-button.gold {
            background-color: var(--bg-button-gold);
            color: var(--text-button-gold);
        }
        body.pastel-pink-mode .history-action-button.gold:hover:not(:disabled),
        body.pastel-blue-mode .history-action-button.gold:hover:not(:disabled),
        body.pastel-yellow-mode .history-action-button.gold:hover:not(:disabled),
        body.pastel-purple-mode .history-action-button.gold:hover:not(:disabled),
        body.pastel-rainbow-mode .history-action-button.gold:hover:not(:disabled) {
            background-color: var(--bg-button-gold-hover);
        }
        body.pastel-pink-mode .history-action-button.purple,
        body.pastel-blue-mode .history-action-button.purple,
        body.pastel-yellow-mode .history-action-button.purple,
        body.pastel-purple-mode .history-action-button.purple,
        body.pastel-rainbow-mode .history-action-button.purple {
            background-color: var(--bg-button-purple);
            color: var(--text-button-purple);
        }
        body.pastel-pink-mode .history-action-button.purple:hover:not(:disabled),
        body.pastel-blue-mode .history-action-button.purple:hover:not(:disabled),
        body.pastel-yellow-mode .history-action-button.purple:hover:not(:disabled),
        body.pastel-purple-mode .history-action-button.purple:hover:not(:disabled),
        body.pastel-rainbow-mode .history-action-button.purple:hover:not(:disabled) {
            background-color: var(--bg-button-purple-hover);
        }

        .header-save-button {
            padding: 4px 12px;
            font-size: 13px;
            background-color: var(--bg-button-save);
            color: var(--text-light);
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        .header-save-button:hover:not(:disabled) {
            background-color: var(--bg-button-save-hover);
        }
        body.dark-mode .header-save-button {
             background-color: var(--bg-button-save);
        }
        body.dark-mode .header-save-button:hover:not(:disabled) {
             background-color: var(--bg-button-save-hover);
        }
        .header-notice {
            font-size: 11px;
            font-weight: normal;
            color: rgba(255, 255, 255, 0.8);
            text-align: right;
            white-space: nowrap;
            flex-shrink: 0;
        }
        body.dark-mode .header-notice {
            color: rgba(255, 255, 255, 0.7);
        }
        body.pastel-pink-mode .header-notice,
        body.pastel-blue-mode .header-notice,
        body.pastel-yellow-mode .header-notice,
        body.pastel-purple-mode .header-notice,
        body.pastel-rainbow-mode .header-notice {
            color: var(--text-light);
            opacity: 0.9;
        }
        body.pastel-yellow-mode .header-button,
        body.pastel-yellow-mode .header-notice {
            color: #424242;
        }
        body.pastel-yellow-mode .new-chat-button,
        body.pastel-yellow-mode .app-header .action-button-in-header,
        body.pastel-yellow-mode .header-save-button {
            color: #424242;
        }
        body.pastel-rainbow-mode .header-button,
        body.pastel-rainbow-mode .header-notice,
        body.pastel-rainbow-mode .new-chat-button,
        body.pastel-rainbow-mode .app-header .action-button-in-header,
        body.pastel-rainbow-mode .header-save-button {
            color: var(--text-light);
        }


        .new-chat-button {
            font-size: 14px;
            padding: 5px 10px;
            background-color: var(--bg-button-save);
            color: var(--text-light);
            flex-shrink: 0;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .new-chat-button:hover {
            background-color: var(--bg-button-save-hover);
        }
        body.dark-mode .new-chat-button {
            background-color: var(--bg-button-save);
        }
        body.dark-mode .new-chat-button:hover {
            background-color: var(--bg-button-save-hover);
        }
        .app-header .action-button-in-header {
            padding: 5px 10px;
            font-size: 14px;
            color: var(--text-light);
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        .app-header #delete-session-btn {
            background-color: var(--bg-button-header-delete);
        }
        .app-header #delete-session-btn:hover:not(:disabled) {
            background-color: var(--bg-button-header-delete-hover);
        }
        .app-header #copy-session-btn {
            background-color: var(--bg-button-header-copy);
        }
        .app-header #copy-session-btn:hover:not(:disabled) {
            background-color: var(--bg-button-header-copy-hover);
        }

        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            position: relative;
            z-index: 1;
            touch-action: pan-y;
        }
        .main-content > .system-prompt-area:not(.system-prompt-sticky) {
            margin-bottom: 15px;
        }


        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-in-out;
            background-color: var(--bg-primary);
            z-index: 0;
        }
        .screen.active {
            transform: translateX(0);
            z-index: 1;
        }
        #chat-screen { transform: translateX(0); }
        #history-screen { transform: translateX(-100%); }
        #settings-screen { transform: translateX(100%); }

        #chat-screen {
            position: relative;
            z-index: 0;
            background-image: var(--chat-background-image);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.3s ease, transform 0.3s ease-in-out;
        }

        #chat-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(var(--overlay-base-rgb), var(--chat-overlay-alpha));
            z-index: 0;
            transition: background-color 0.3s ease;
            pointer-events: none;
        }

        #chat-screen .main-content {
            z-index: 1;
            background-color: transparent;
            overflow-y: scroll;
            overflow-x: auto;
            touch-action: pan-x pan-y pinch-zoom;
            flex-grow: 1;
        }
        #chat-screen .app-header { z-index: 2; }

        #chat-screen .system-prompt-area.system-prompt-sticky,
        #chat-screen #memo-area:not(.hidden),
        #chat-screen #clipboard-stack-area:not(.hidden) {
            z-index: 2;
        }

        #chat-screen .chat-input-area {
            z-index: 2;
            background-color: rgba(var(--bg-secondary-rgb, 240, 242, 245), var(--header-footer-opacity, 1));
        }
        #history-screen .main-content,
        #settings-screen .main-content {
            touch-action: pan-y;
        }

        #memo-area {
            position: relative;
            width: 100%;
            min-height: 80px;
            max-height: var(--memo-height);
            background-color: var(--bg-memo);
            border-bottom: 1px solid var(--border-secondary);
            padding: 10px 15px;
            z-index: 4;
            box-shadow: 0 1px 3px var(--shadow-primary);
            overflow: auto;
            display: flex;
            flex-direction: column;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, opacity 0.3s ease-out, border-width 0.3s ease-out;
            resize: vertical;
            margin-bottom: 0;
        }

        #memo-area.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            max-height: 0 !important;
            min-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border-width: 0 !important;
            overflow: hidden;
        }

        .memo-actions-container {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding-bottom: 8px;
            flex-shrink: 0;
        }
        .memo-actions-container button {
            padding: 4px 10px;
            font-size: 12px;
        }
        .memo-actions-container .delete-memo-btn {
            background-color: var(--bg-button-delete);
        }
        .memo-actions-container .delete-memo-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .memo-actions-container .copy-memo-btn {
            background-color: var(--bg-button-copy);
        }
        .memo-actions-container .copy-memo-btn:hover {
            background-color: var(--bg-button-copy-hover);
        }
        .memo-actions-container .paste-memo-btn {
            background-color: var(--bg-button-paste);
        }
        .memo-actions-container .paste-memo-btn:hover {
            background-color: var(--bg-button-paste-hover);
        }

        #memo-editor {
            flex-grow: 1;
            width: 100%;
            border: none;
            resize: none;
            background-color: transparent;
            color: var(--text-memo);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            padding: 0;
            margin: 0;
            min-height: 50px;
            display: block;
        }

        #clipboard-stack-area {
            position: relative;
            width: 100%;
            min-height: 80px;
            max-height: var(--clipboard-stack-height);
            background-color: var(--bg-memo);
            border-bottom: 1px solid var(--border-secondary);
            padding: 10px 15px;
            z-index: 5;
            box-shadow: 0 1px 3px var(--shadow-primary);
            overflow: auto;
            display: flex;
            flex-direction: column;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, opacity 0.3s ease-out, border-width 0.3s ease-out;
            resize: vertical;
            margin-bottom: 0;
        }

        #clipboard-stack-area.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            max-height: 0 !important;
            min-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border-width: 0 !important;
            overflow: hidden;
        }

        .clipboard-stack-actions-container {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding-bottom: 8px;
            flex-shrink: 0;
        }
        .clipboard-stack-actions-container button {
            padding: 4px 10px;
            font-size: 12px;
        }
        .clipboard-stack-actions-container .delete-clipboard-stack-btn {
            background-color: var(--bg-button-delete);
        }
        .clipboard-stack-actions-container .delete-clipboard-stack-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .clipboard-stack-actions-container .copy-clipboard-stack-btn {
            background-color: var(--bg-button-copy);
        }
        .clipboard-stack-actions-container .copy-clipboard-stack-btn:hover {
            background-color: var(--bg-button-copy-hover);
        }
        .clipboard-stack-actions-container .paste-clipboard-stack-btn {
            background-color: var(--bg-button-paste);
        }
        .clipboard-stack-actions-container .paste-clipboard-stack-btn:hover {
            background-color: var(--bg-button-paste-hover);
        }

        #clipboard-stack-editor {
            flex-grow: 1;
            width: 100%;
            border: none;
            resize: none;
            background-color: transparent;
            color: var(--text-memo);
            font-family: inherit;
            font-size: 14px;
            outline: none;
            padding: 0;
            margin: 0;
            min-height: 50px;
            display: block;
        }

        .system-prompt-area:not(.system-prompt-sticky) {
            padding: 10px 15px;
            border: 1px solid var(--border-system);
            border-radius: 8px;
            background-color: var(--bg-system-message);
            color: var(--text-system);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, opacity 0.3s ease, visibility 0.3s ease, max-height 0.3s ease;
            position: relative;
            z-index: 1;
            overflow: hidden;
            max-height: 500px;
        }

        .system-prompt-area:not(.system-prompt-sticky).hidden {
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
            border-width: 0 !important;
            max-height: 0 !important;
            opacity: 0 !important;
            visibility: hidden !important;
            overflow: hidden !important;
        }

        .system-prompt-area.system-prompt-sticky {
            position: relative;
            width: 100%;
            background-color: var(--bg-memo);
            border-style: solid;
            border-color: var(--border-secondary);
            border-width: 0 0 1px 0;
            padding: 10px 15px;
            z-index: 3;
            box-shadow: 0 1px 3px var(--shadow-primary);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, opacity 0.3s ease-out, border-width 0.3s ease-out;
            margin-bottom: 0;
            border-radius: 0;
            color: var(--text-memo);
            max-height: 130px;
        }

        .system-prompt-area.system-prompt-sticky.details-open {
            height: auto;
            overflow: auto;
            background-color: var(--bg-memo);
            color: var(--text-memo);
        }

        .system-prompt-area.system-prompt-sticky.details-closed {
            max-height: 30px;
            padding-top: 5px;
            padding-bottom: 5px;
            overflow: hidden;
            background-color: var(--bg-memo);
            color: var(--text-memo);
        }

        .system-prompt-area.system-prompt-sticky.details-closed .system-prompt-content {
            display: none;
        }

        .system-prompt-area.system-prompt-sticky.hidden {
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border-width: 0 !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }

        .system-prompt-area.system-prompt-sticky summary {
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-memo);
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        .system-prompt-area.system-prompt-sticky summary::-webkit-details-marker { display: none; }
        .system-prompt-area.system-prompt-sticky summary::marker { display: none; }
        .system-prompt-area.system-prompt-sticky summary::after {
            content: '▼';
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
            color: var(--text-memo);
        }

        .system-prompt-area.system-prompt-sticky details[open] summary::after {
            transform: rotate(180deg);
        }

        .system-prompt-area.system-prompt-sticky .system-prompt-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 0;
            margin-top: 10px;
        }

        .system-prompt-area.system-prompt-sticky .system-prompt-content textarea {
            flex-grow: 1;
            resize: none;
            margin-bottom: 0;
            border-radius: 5px;
            padding-bottom: 5px;
            padding-right: 145px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .system-prompt-area.system-prompt-sticky .system-prompt-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: transparent;
            padding: 0;
        }

        .system-prompt-area:not(.system-prompt-sticky) details {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .system-prompt-area:not(.system-prompt-sticky) summary {
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-primary);
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .system-prompt-area:not(.system-prompt-sticky) summary::-webkit-details-marker { display: none; }
        .system-prompt-area:not(.system-prompt-sticky) summary::marker { display: none; }
        .system-prompt-area:not(.system-prompt-sticky) summary::after {
            content: '▼';
            font-size: 10px;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .system-prompt-area:not(.system-prompt-sticky) details[open] summary::after {
            transform: rotate(180deg);
        }

        .system-prompt-area:not(.system-prompt-sticky) .system-prompt-content {
            margin-top: 10px;
        }

        .system-prompt-area:not(.system-prompt-sticky) .system-prompt-content textarea {
            width: 100%;
            min-height: 60px;
            max-height: 200px;
            margin-bottom: 8px;
            font-size: 13px;
            background-color: var(--bg-input);
            color: var(--text-primary);
            border-color: var(--border-primary);
            resize: none;
        }

        .system-prompt-area:not(.system-prompt-sticky) .system-prompt-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .system-prompt-area:not(.system-prompt-sticky) .system-prompt-actions button {
            padding: 4px 10px;
            font-size: 12px;
        }

        .system-prompt-area:not(.system-prompt-sticky) .system-prompt-actions .save-system-prompt-btn {
            background-color: var(--bg-button-save);
        }
        .system-prompt-area:not(.system-prompt-sticky) .system-prompt-actions .save-system-prompt-btn:hover {
            background-color: var(--bg-button-save-hover);
        }
        .system-prompt-area:not(.system-prompt-sticky) .system-prompt-actions .cancel-system-prompt-btn {
            background-color: var(--bg-button-cancel);
        }
        .system-prompt-area:not(.system-prompt-sticky) .system-prompt-actions .cancel-system-prompt-btn:hover {
            background-color: var(--bg-button-cancel-hover);
        }

        .system-prompt-area.system-prompt-sticky .system-prompt-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            padding: 0;
            flex-shrink: 0;
        }

        .system-prompt-area.system-prompt-sticky .system-prompt-actions button {
            padding: 4px 10px;
            font-size: 12px;
        }

        .system-prompt-area.system-prompt-sticky .system-prompt-actions .save-system-prompt-btn {
            background-color: var(--bg-button-save);
        }
        .system-prompt-area.system-prompt-sticky .system-prompt-actions .save-system-prompt-btn:hover {
            background-color: var(--bg-button-save-hover);
        }
        .system-prompt-area.system-prompt-sticky .system-prompt-actions .cancel-system-prompt-btn {
            background-color: var(--bg-button-cancel);
        }
        .system-prompt-area.system-prompt-sticky .system-prompt-actions .cancel-system-prompt-btn:hover {
            background-color: var(--bg-button-cancel-hover);
        }


        .message-container {
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }
        .message {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: var(--message-max-width);
            min-width: 30%;
            min-height: 40px;
            position: relative;
            word-wrap: break-word;
            margin-top: 35px;
            margin-bottom: 35px;
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease, opacity 0.3s ease;
            z-index: 1;
            box-shadow: 0 1px 2px var(--shadow-primary);
        }
        .message-icon {
            width: var(--message-icon-size);
            height: var(--message-icon-size);
            border-radius: 50%;
            object-fit: cover;
            position: absolute;
            top: calc( (var(--message-icon-size) / -2 + 2px) + var(--message-icon-offset-y, 0px) );
            border: 1px solid var(--border-secondary);
            background-color: var(--bg-tertiary);
            box-shadow: 0 1px 2px var(--shadow-primary);
            z-index: 2;
        }
        .message.user .message-icon {
            right: 5px;
        }
        .message.model .message-icon {
            left: 5px;
        }

        .message-icon-name {
            position: absolute;
            font-size: var(--icon-name-font-size, 10px);
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
            z-index: 2;
            top: calc(var(--message-icon-size) + var(--message-icon-offset-y, 0px) - (var(--message-icon-size) / 4) + var(--icon-name-offset-y, 0px) );
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            line-height: 1.3;
        }
        .message.user .message-icon-name {
            left: auto;
            right: calc(var(--message-icon-size) + 8px);
            text-align: right;
        }
        .message.model .message-icon-name {
            left: calc(var(--message-icon-size) + 8px);
            right: auto;
            text-align: left;
        }

        .message.user .message-icon-name.has-bubble {
            background-color: var(--user-name-bubble-bg);
            padding-top: var(--user-name-bubble-padding-y);
            padding-bottom: var(--user-name-bubble-padding-y);
            padding-left: calc(var(--icon-name-font-size, 10px) * var(--user-name-bubble-padding-x-ratio));
            padding-right: calc(var(--icon-name-font-size, 10px) * var(--user-name-bubble-padding-x-ratio));
            border-radius: var(--user-name-bubble-border-radius);
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        .message.model .message-icon-name.has-bubble {
            background-color: var(--ai-name-bubble-bg);
            padding-top: var(--ai-name-bubble-padding-y);
            padding-bottom: var(--ai-name-bubble-padding-y);
            padding-left: calc(var(--icon-name-font-size, 10px) * var(--ai-name-bubble-padding-x-ratio));
            padding-right: calc(var(--icon-name-font-size, 10px) * var(--ai-name-bubble-padding-x-ratio));
            border-radius: var(--ai-name-bubble-border-radius);
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }


        .message.message-hidden-by-toggle {
            visibility: hidden;
            opacity: 0;
            max-height: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            margin-bottom: 0 !important;
            border-width: 0 !important;
            overflow: hidden;
        }
        .message.message-hidden-by-toggle .message-actions,
        .message.message-hidden-by-toggle .message-cascade-controls,
        .message.message-hidden-by-toggle .message-toggle-button,
        .message.message-hidden-by-toggle .message-icon,
        .message.message-hidden-by-toggle .message-icon-name,
        .message.message-hidden-by-toggle .thought-summary-details {
            display: none !important;
        }
        .message.message-content-collapsed-fully .thought-summary-details {
            display: none !important;
        }


        .message:first-child {
            margin-top: 0;
        }
        .message pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: var(--message-body-font-size);
            margin: 0;
            color: inherit;
            transition: opacity 0.2s ease;
        }
        .message.user {
            background-color: rgba(var(--bg-user-message-rgb, 220, 248, 198), var(--message-bubble-opacity, 1));
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            body:not(.dark-mode):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) & { color: #333; }
            body.dark-mode & { color: #e0e0e0; }
            body.pastel-pink-mode &, body.pastel-blue-mode &, body.pastel-yellow-mode &, body.pastel-purple-mode &, body.pastel-rainbow-mode & { color: var(--text-primary); }
        }
        .message.model {
            background-color: rgba(var(--bg-model-message-rgb, 229, 229, 234), var(--message-bubble-opacity, 1));
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            max-width: 90%;
        }
        .message.error {
            background-color: var(--bg-error-message);
            color: var(--text-error);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .message-content.collapsed {
            max-height: 50px;
            overflow: hidden;
            position: relative;
        }
        .message-content.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            pointer-events: none;
        }
        body:not(.dark-mode):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) .message.user .message-content.collapsed::after {
             background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, var(--bg-user-message) 100%);
        }
        body:not(.dark-mode):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) .message.model .message-content.collapsed::after {
             background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, var(--bg-model-message) 100%);
        }
        body.dark-mode .message.user .message-content.collapsed::after {
             background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.dark-mode .message.model .message-content.collapsed::after {
             background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-pink-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-pink-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-blue-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-blue-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-yellow-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-yellow-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-purple-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-purple-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }
        body.pastel-rainbow-mode .message.user .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-user-message) 100%);
        }
        body.pastel-rainbow-mode .message.model .message-content.collapsed::after {
            background: linear-gradient(to bottom, rgba(var(--overlay-base-rgb),0) 0%, var(--bg-model-message) 100%);
        }


        .message-toggle-button {
            position: absolute;
            background-color: var(--bg-toggle-button);
            color: var(--text-toggle-button);
            border: none;
            border-radius: 4px;
            padding: 16px 1px;
            line-height: 1;
            cursor: pointer;
            z-index: 3;
            opacity: 0.6;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            pointer-events: auto;
            min-width: auto;
            white-space: nowrap;
        }
        .message-toggle-button:hover {
            background-color: var(--bg-toggle-button-hover);
        }
        .message:hover .message-toggle-button.top,
        .message.show-actions .message-toggle-button.top {
             opacity: calc(var(--message-toggle-button-top-opacity) + 0.1);
        }
        .message:hover .message-toggle-button.bottom,
        .message.show-actions .message-toggle-button.bottom {
            opacity: 1;
        }


        .message-toggle-button.top {
            top: 3px;
            right: 3px;
            left: auto;
            z-index: 3;
            font-size: var(--message-toggle-button-top-font-size);
            width: var(--message-toggle-button-top-width);
            height: var(--message-toggle-button-top-height);
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: var(--message-toggle-button-top-opacity);
        }

        .message-toggle-button.bottom {
            position: static;
            flex-shrink: 0;
            padding: 4px 10px;
            font-size: var(--message-toggle-button-bottom-font-size);
            line-height: 1.5;
        }

        .message-actions {
            position: absolute;
            bottom: -30px;
            display: none;
            flex-wrap: nowrap;
            gap: 5px;
            background-color: rgba(var(--message-actions-base-rgb), var(--message-actions-bg-opacity));
            padding: 1px 1px 1px 1px;
            border-radius: 5px;
            box-shadow: 0 1px 3px var(--shadow-primary);
            z-index: 2;
            transition: opacity 0.2s ease, background-color 0.3s ease;
        }

        .message.user .message-actions {
            right: 0;
            left: auto;
            justify-content: flex-end;
        }
        .message.model .message-actions {
            left: 0;
            right: auto;
            justify-content: flex-start;
        }
        .message-actions button {
            background-color: var(--bg-button-action);
            color: var(--text-light);
            padding: 4px 10px;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            line-height: 1.5;
        }
        body.pastel-yellow-mode .message-actions button,
        body.pastel-yellow-mode .message-cascade-controls button,
        body.pastel-yellow-mode .message-edit-actions button {
            color: var(--text-light);
        }


        .message-actions button:hover {
            background-color: var(--bg-button-action-hover);
        }
        .message-actions .js-edit-btn { background-color: var(--bg-button-edit); }
        .message-actions .js-edit-btn:hover { background-color: var(--bg-button-edit-hover); }
        .message-actions .js-delete-btn { background-color: var(--bg-button-delete); }
        .message-actions .js-delete-btn:hover { background-color: var(--bg-button-delete-hover); }
        .message-actions .js-retry-btn { background-color: var(--bg-button-retry); }
        .message-actions .js-retry-btn:hover { background-color: var(--bg-button-retry-hover); }
        .message-actions .js-copy-btn {
            background-color: var(--bg-button-copy);
        }
        .message-actions .js-copy-btn:hover {
            background-color: var(--bg-button-copy-hover);
        }

        .message-cascade-controls {
            position: absolute;
            top: -35px;
            left: 0;
            display: none;
            align-items: center;
            flex-wrap: nowrap;
            gap: 5px;
            background-color: rgba(var(--message-actions-base-rgb), var(--message-actions-bg-opacity));
            padding: 5px 8px 10px 8px;
            border-radius: 5px;
            box-shadow: 0 -1px 3px var(--shadow-primary);
            z-index: 2;
            transition: opacity 0.2s ease, background-color 0.3s ease;
        }
        .message.model:hover .message-cascade-controls,
        .message.model.show-actions .message-cascade-controls {
            display: flex;
        }
        .message-cascade-controls button {
            background-color: var(--bg-cascade-button);
            color: var(--text-light);
            padding: 4px 8px;
            font-size: 14px;
            border-radius: 4px;
            line-height: 1;
            min-width: 25px;
        }
        .message-cascade-controls button:hover:not(:disabled) {
            background-color: var(--bg-cascade-button-hover);
        }
        .message-cascade-controls button:disabled {
            background-color: var(--bg-button-disabled);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .message-cascade-controls .cascade-indicator {
            font-size: 11px;
            color: var(--text-cascade-indicator);
            padding: 0 5px;
            white-space: nowrap;
            font-weight: 500;
        }
        .message-cascade-controls .cascade-delete-btn {
            background-color: var(--bg-cascade-delete-button);
            margin-left: 5px;
        }
        .message-cascade-controls .cascade-delete-btn:hover {
            background-color: var(--bg-cascade-delete-button-hover);
        }

        .message.editing pre {
            opacity: 0;
            height: 0;
            overflow: hidden;
            pointer-events: none;
        }
        .message.editing .message-actions,
        .message.editing .message-cascade-controls,
        .message.editing .message-toggle-button {
             opacity: 0;
             pointer-events: none;
             display: none !important;
        }
        .message-edit-area {
            margin-top: 5px;
        }
        .message-edit-area textarea {
            min-height: 60px;
            margin-bottom: 5px;
            width: 100%;
        }
        .message-edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 5px;
        }
        .message-edit-actions button {
            padding: 4px 10px;
            font-size: 12px;
        }
        .message-edit-actions .save-edit-btn { background-color: var(--bg-button-save); }
        .message-edit-actions .save-edit-btn:hover { background-color: var(--bg-button-save-hover); }
        .message-edit-actions .cancel-edit-btn { background-color: var(--bg-button-cancel); }
        .message-edit-actions .cancel-edit-btn:hover { background-color: var(--bg-button-cancel-hover); }

        .chat-input-area {
            display: flex;
            align-items: flex-end;
            padding: 10px 15px;
            border-top: 1px solid var(--border-primary);
            flex-shrink: 0;
            box-sizing: border-box;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            gap: 10px;
        }
        .footer-action-button {
            height: 40px;
            width: 40px;
            padding: 0;
            font-size: 20px;
            font-weight: bold;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-button-action);
            color: var(--text-light);
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .footer-action-button:hover:not(:disabled) {
            background-color: var(--bg-button-action-hover);
        }
        body.pastel-yellow-mode .footer-action-button {
            color: #424242;
        }
        .chat-input-area button#attach-file-btn {
            position: relative;
        }
        .chat-input-area button#paste-to-input-btn {
            font-size: 16px;
        }

        .attachment-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: var(--badge-size);
            height: var(--badge-size);
            background-color: var(--badge-color);
            border-radius: 50%;
            border: 1px solid var(--bg-primary);
            display: none;
            pointer-events: none;
        }
        .chat-input-area button#attach-file-btn.has-attachments .attachment-badge {
            display: block;
        }
        .chat-input-area textarea {
            flex-grow: 1;
            min-height: 40px;
            max-height: 200px;
            height: 40px;
            resize: none;
            margin-bottom: 0;
            padding: 8px 10px;
            overflow-y: auto;
        }
        .chat-input-area button#send-button {
            height: 40px;
            width: 40px;
            padding: 0;
            font-size: 18px;
            font-weight: bold;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-input-area button#send-button.sending {
            background-color: #ffc107;
            color: #333;
        }
        .chat-input-area button#send-button.sending:hover {
            background-color: #ffa000;
        }
        body.dark-mode .chat-input-area button#send-button.sending {
            background-color: #ffd60a;
            color: #1a1a1a;
        }
        body.dark-mode .chat-input-area button#send-button.sending:hover {
            background-color: #ffca28;
        }
        body.pastel-pink-mode .chat-input-area button#send-button.sending,
        body.pastel-blue-mode .chat-input-area button#send-button.sending,
        body.pastel-yellow-mode .chat-input-area button#send-button.sending,
        body.pastel-purple-mode .chat-input-area button#send-button.sending,
        body.pastel-rainbow-mode .chat-input-area button#send-button.sending {
            background-color: #ffee88;
            color: #554400;
        }
        body.pastel-pink-mode .chat-input-area button#send-button.sending:hover,
        body.pastel-blue-mode .chat-input-area button#send-button.sending:hover,
        body.pastel-yellow-mode .chat-input-area button#send-button.sending:hover,
        body.pastel-purple-mode .chat-input-area button#send-button.sending:hover,
        body.pastel-rainbow-mode .chat-input-area button#send-button.sending:hover {
            background-color: #ffe766;
        }


        #loading-indicator {
            position: fixed;
            bottom: 65px;
            right: 20px;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-style: normal;
            font-weight: 500;
            z-index: 3;
            box-shadow: 0 2px 5px var(--shadow-primary);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            pointer-events: none;
        }
        #loading-indicator:not(.hidden) {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        body.dark-mode #loading-indicator {
            background-color: var(--bg-input);
            color: var(--text-secondary);
            box-shadow: 0 2px 6px var(--shadow-secondary);
        }

        #history-screen {
             background-color: var(--bg-primary);
             transition: transform 0.3s ease-in-out;
        }
        #history-screen .main-content {
             background-color: transparent;
        }

        .history-list {
            list-style: none;
            padding: 0;
        }
        .history-item {
            padding: 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: var(--bg-primary);
            transition: background-color 0.2s ease, border-color 0.3s ease;
            cursor: pointer;
        }
        .history-item:hover {
            background-color: var(--bg-tertiary);
        }
        .history-item-details {
            overflow: hidden;
            min-width: 0;
            width: 100%;
            margin-bottom: 8px;
        }
        .history-item-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 0px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            display: block;
            color: var(--text-primary);
        }
        .history-item-bottom-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .history-item-dates {
            font-size: 9px;
            color: var(--text-secondary);
            flex-shrink: 0;
            line-height: 1.3;
            text-align: left;
        }
        .history-item-dates span {
            display: block;
            white-space: nowrap;
        }
        .history-item-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
            flex-wrap: nowrap;
            cursor: default;
        }
        .history-item-actions button {
             cursor: pointer;
        }
        .history-item-actions .js-edit-title-btn {
            background-color: var(--bg-button-edit);
            font-size: 16px;
            padding: 6px 8px;
        }
        .history-item-actions .js-edit-title-btn:hover { background-color: var(--bg-button-edit-hover); }
        .history-item-actions .js-delete-btn { background-color: var(--bg-button-delete); }
        .history-item-actions .js-delete-btn:hover { background-color: var(--bg-button-delete-hover); }
        .history-item-actions .js-duplicate-btn { background-color: var(--bg-button-duplicate); }
        .history-item-actions .js-duplicate-btn:hover { background-color: var(--bg-button-duplicate-hover); }
        .history-item-actions .js-export-btn { background-color: var(--bg-button-export); }
        .history-item-actions .js-export-btn:hover { background-color: var(--bg-button-export-hover); }
        .history-item-actions .js-link-session-btn,
        .history-item-actions .js-export-btn,
        .history-item-actions .js-duplicate-btn,
        .history-item-actions .js-delete-btn {
             padding: 6px 8px;
             font-size: 16px;
        }

        .js-history-item-template {
             display: none !important;
        }
        #no-history-message {
            text-align: center;
            color: var(--text-secondary);
            margin-top: 20px;
        }

        #settings-screen {
             background-color: var(--bg-primary);
             transition: transform 0.3s ease-in-out;
        }
         #settings-screen .main-content {
             background-color: transparent;
        }

        .settings-group {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid var(--border-tertiary);
            border-radius: 8px;
            background-color: var(--bg-tertiary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .settings-group h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--text-link);
            border-bottom: 1px solid var(--border-tertiary);
            padding-bottom: 5px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .settings-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-tertiary);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .settings-actions.bottom {
            margin-bottom: 20px;
        }
        .settings-actions button {
            width: 100%;
        }
        .danger-zone {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border-danger);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .danger-zone button {
            width: 100%;
        }
        #update-app-btn {
            background-color: var(--bg-button-update);
        }
        #update-app-btn:hover {
            background-color: var(--bg-button-update-hover);
        }
        #clear-data-btn {
            background-color: var(--bg-button-delete);
        }
        #clear-data-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            color: var(--text-primary);
        }
        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin-bottom: 0;
            cursor: pointer;
        }
        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .image-upload-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .settings-action-button {
            background-color: var(--bg-button-action);
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            color: var(--text-light);
            cursor: pointer;
        }
        .settings-action-button:hover {
            background-color: var(--bg-button-action-hover);
        }
        .settings-delete-button {
            background-color: var(--bg-button-delete);
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            color: var(--text-light);
            cursor: pointer;
            margin-left: auto;
        }
        .settings-delete-button:hover {
            background-color: var(--bg-button-delete-hover);
        }
        .background-thumbnail {
            max-width: 100px;
            max-height: 60px;
            border-radius: 4px;
            border: 1px solid var(--border-tertiary);
            object-fit: cover;
            vertical-align: middle;
        }
        .icon-thumbnail {
            max-width: 40px;
            max-height: 40px;
            border-radius: 50%;
            border: 1px solid var(--border-tertiary);
            object-fit: cover;
            vertical-align: middle;
            margin-left: 10px;
        }

        @media (prefers-color-scheme: dark) {
          body:not(.light-mode-forced):not(.pastel-pink-mode):not(.pastel-blue-mode):not(.pastel-yellow-mode):not(.pastel-purple-mode):not(.pastel-rainbow-mode) {
            --bg-primary: #1a1a1a;
            --text-primary: #e0e0e0;
          }
        }

        .message-content {
            font-size: var(--message-body-font-size);
            line-height: 1.6;
            color: inherit;
            word-wrap: break-word;
            overflow-wrap: break-word;
            position: relative;
            z-index: 1;
        }
        .message-content > *:first-child { margin-top: 0; }
        .message-content > *:last-child { margin-bottom: 0; }
        .message-content h1, .message-content h2, .message-content h3, .message-content h4, .message-content h5, .message-content h6 {
            margin-top: 1.2em;
            margin-bottom: 0.6em;
            font-weight: bold;
            line-height: 1.3;
            color: inherit;
        }
        .message-content h1 { font-size: 1.8em; }
        .message-content h2 { font-size: 1.5em; }
        .message-content h3 { font-size: 1.3em; }
        .message-content h4 { font-size: 1.1em; }
        .message-content p {
            margin-bottom: 0.8em;
        }
        .message-content ul, .message-content ol {
            margin-bottom: 0.8em;
            padding-left: 2em;
        }
        .message-content li {
            margin-bottom: 0.3em;
        }
        .message-content li > ul, .message-content li > ol {
             margin-top: 0.3em;
             margin-bottom: 0.3em;
        }
        .message-content pre {
            background-color: var(--bg-secondary);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 1em 0;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: var(--code-block-font-size);
            border: 1px solid var(--border-tertiary);
            color: var(--text-secondary);
            position: relative;
        }
        .message-content pre .code-copy-button {
            position: absolute;
            bottom: 5px;
            right: 5px;
            padding: 3px 8px;
            font-size: 10px;
            background-color: var(--bg-code-copy-button);
            color: var(--text-code-copy-button);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .message-content pre:hover .code-copy-button {
            opacity: 1;
        }
        .message-content pre .code-copy-button:hover {
            background-color: var(--bg-code-copy-button-hover);
        }
        body.pastel-yellow-mode .message-content pre .code-copy-button {
            color: var(--text-light);
        }

        .message.user .message-content pre {
             background-color: transparent;
             padding: 0;
             margin: 0;
             border: none;
             border-radius: 0;
             color: inherit;
             font-family: inherit;
             font-size: var(--message-body-font-size);
             line-height: inherit;
             white-space: pre-wrap;
             word-wrap: break-word;
             overflow-x: visible;
             position: static;
        }
        .message.user .message-content pre .code-copy-button {
            display: none;
        }
        .message-content code:not(pre > code) {
            background-color: var(--bg-secondary);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            border: 1px solid var(--border-tertiary);
            color: var(--text-secondary);
        }
        .message-content blockquote {
            margin: 1em 0;
            padding-left: 1em;
            border-left: 4px solid var(--border-primary);
            color: var(--text-secondary);
        }
        .message-content blockquote > *:first-child { margin-top: 0; }
        .message-content blockquote > *:last-child { margin-bottom: 0; }
        .message-content a {
            color: var(--text-link);
            text-decoration: underline;
        }
        .message-content strong {
            font-weight: bold;
        }
        .message-content em {
            font-style: italic;
        }
        .message-content table {
            border-collapse: collapse;
            margin: 1em 0;
            width: auto;
            border: 1px solid var(--border-secondary);
        }
        .message-content th, .message-content td {
            border: 1px solid var(--border-secondary);
            padding: 6px 10px;
            text-align: left;
        }
        .message-content th {
            background-color: var(--bg-tertiary);
            font-weight: bold;
        }
        .message-content hr {
            border: none;
            border-top: 1px solid var(--border-secondary);
            margin: 1.5em 0;
        }

        .message:hover .message-actions,
        .message.show-actions .message-actions {
            display: flex;
        }
        .message.model:hover .message-cascade-controls,
        .message.model.show-actions .message-cascade-controls {
             display: flex;
        }
        .message:hover .message-toggle-button.top,
        .message.show-actions .message-toggle-button.top {
             opacity: calc(var(--message-toggle-button-top-opacity) + 0.1);
        }
        .message:hover .message-toggle-button.bottom,
        .message.show-actions .message-toggle-button.bottom {
             opacity: 1;
        }


        .message.editing.show-actions .message-actions,
        .message.editing.show-actions .message-cascade-controls,
        .message.editing.show-actions .message-toggle-button {
            display: none !important;
        }
        .message.retrying-hidden {
            display: none !important;
        }
        body.dark-mode .message-content pre {
            background-color: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-secondary);
        }
         body.dark-mode .message-content code:not(pre > code) {
            background-color: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-secondary);
        }
        body.dark-mode .message-content blockquote {
            border-left-color: var(--border-primary);
            color: var(--text-secondary);
        }
         body.dark-mode .message-content a {
            color: var(--text-link);
         }
        body.dark-mode .message-content table,
        body.dark-mode .message-content th,
        body.dark-mode .message-content td {
            border-color: var(--border-primary);
        }
        body.dark-mode .message-content th {
            background-color: var(--bg-secondary);
        }
        body.dark-mode .message-content hr {
            border-top-color: var(--border-primary);
        }
        body.pastel-pink-mode .message-content pre,
        body.pastel-blue-mode .message-content pre,
        body.pastel-yellow-mode .message-content pre,
        body.pastel-purple-mode .message-content pre,
        body.pastel-rainbow-mode .message-content pre {
            background-color: var(--bg-tertiary);
            border-color: var(--border-secondary);
            color: var(--text-secondary);
        }
        body.pastel-pink-mode .message-content code:not(pre > code),
        body.pastel-blue-mode .message-content code:not(pre > code),
        body.pastel-yellow-mode .message-content code:not(pre > code),
        body.pastel-purple-mode .message-content code:not(pre > code),
        body.pastel-rainbow-mode .message-content code:not(pre > code) {
            background-color: var(--bg-tertiary);
            border-color: var(--border-secondary);
            color: var(--text-secondary);
        }
        body.pastel-pink-mode .message-content blockquote,
        body.pastel-blue-mode .message-content blockquote,
        body.pastel-yellow-mode .message-content blockquote,
        body.pastel-purple-mode .message-content blockquote,
        body.pastel-rainbow-mode .message-content blockquote {
            border-left-color: var(--border-primary);
            color: var(--text-secondary);
        }
        body.pastel-pink-mode .message-content th,
        body.pastel-blue-mode .message-content th,
        body.pastel-yellow-mode .message-content th,
        body.pastel-purple-mode .message-content th,
        body.pastel-rainbow-mode .message-content th {
            background-color: var(--bg-secondary);
        }


        .message-actions .token-count-display {
            font-size: 0.7rem;
            color: var(--text-secondary);
            vertical-align: middle;
            line-height: 1.5;
            white-space: nowrap;
        }

        .custom-dialog {
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            padding: 25px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: 0 5px 20px var(--shadow-secondary);
            min-width: 280px;
            max-width: 500px;
            width: fit-content;
            box-sizing: border-box;
            margin-left: auto;
            margin-right: auto;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            position: relative;
            z-index: 100;
        }
        .custom-dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            transition: background-color 0.3s ease;
            z-index: 99;
        }

        body.dark-mode .custom-dialog::backdrop {
            background-color: rgba(30, 30, 30, 0.7);
        }
        body.pastel-pink-mode .custom-dialog::backdrop,
        body.pastel-blue-mode .custom-dialog::backdrop,
        body.pastel-yellow-mode .custom-dialog::backdrop,
        body.pastel-purple-mode .custom-dialog::backdrop,
        body.pastel-rainbow-mode .custom-dialog::backdrop {
            background-color: rgba(var(--overlay-base-rgb), 0.4);
        }

        .custom-dialog[open] {
            animation: dialog-fade-in 0.3s ease forwards;
        }
        @keyframes dialog-fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-dialog .dialog-message {
            margin: 0 0 20px 0;
            font-size: 15px;
            line-height: 1.6;
            display: block;
            text-align: left;
        }
        .custom-dialog .dialog-input {
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--bg-input);
            color: var(--text-primary);
        }
        .custom-dialog .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }
        .custom-dialog button {
            padding: 8px 18px;
            font-weight: 500;
            min-width: 80px;
        }
        .custom-dialog .dialog-ok-btn {
            background-color: var(--bg-button);
            color: var(--text-light);
        }
        body.pastel-yellow-mode .custom-dialog .dialog-ok-btn,
        body.pastel-rainbow-mode .custom-dialog .dialog-ok-btn {
             color: var(--text-light);
        }
        .custom-dialog .dialog-ok-btn:hover:not(:disabled) {
            background-color: var(--bg-button-hover);
        }
         .custom-dialog .dialog-cancel-btn {
            background-color: var(--bg-button-action);
            color: var(--text-light);
        }
        body.pastel-yellow-mode .custom-dialog .dialog-cancel-btn,
        body.pastel-rainbow-mode .custom-dialog .dialog-cancel-btn {
             color: var(--text-light);
        }
        .custom-dialog .dialog-cancel-btn:hover:not(:disabled) {
            background-color: var(--bg-button-action-hover);
        }
        .thought-summary-details {
            margin-bottom: 10px;
            font-size: 13px;
            border: 1px solid var(--border-tertiary);
            border-radius: 5px;
            background-color: rgba(var(--bg-tertiary-rgb), var(--thought-summary-opacity));
            transition: background-color 0.3s ease, border-color 0.3s ease, opacity 0.3s ease;
        }
        .thought-summary-details summary {
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            list-style: none;
            padding: 6px 10px;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            gap: 5px;
            user-select: none;
        }
        .thought-summary-details summary::-webkit-details-marker { display: none; }
        .thought-summary-details summary::marker { display: none; }
        .thought-summary-details summary::before {
            content: '💭';
            font-size: 14px;
            display: inline-block;
        }
        .thought-summary-details[open] summary {
            border-bottom: 1px solid var(--border-tertiary);
        }
        .thought-summary-content {
            padding: 8px 10px;
            font-size: var(--thought-summary-font-size);
            line-height: 1.5;
            color: var(--text-primary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .thought-summary-content > *:first-child { margin-top: 0; }
        .thought-summary-content > *:last-child { margin-bottom: 0; }
        .thought-summary-content ul,
        .thought-summary-content ol { margin-left: 1em;}
        body.dark-mode .thought-summary-details {
            border-color: var(--border-primary);
        }
        body.dark-mode .thought-summary-details summary {
            color: var(--text-secondary);
        }
        body.dark-mode .thought-summary-details[open] summary {
            border-bottom-color: var(--border-primary);
        }
        body.dark-mode .thought-summary-content {
            color: var(--text-primary);
        }
        .thought-summary-content pre {
            background-color: var(--bg-secondary);
            padding: 8px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0.8em 0;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: var(--thought-summary-font-size);
            border: 1px solid var(--border-tertiary);
            color: var(--text-secondary);
        }
        body.dark-mode .thought-summary-content pre {
            background-color: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-secondary);
            font-size: var(--thought-summary-font-size);
        }
        .thought-summary-content code:not(pre > code) {
            background-color: var(--bg-secondary);
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
            border: 1px solid var(--border-tertiary);
            color: var(--text-secondary);
        }
        body.dark-mode .thought-summary-content code:not(pre > code) {
            background-color: var(--bg-tertiary);
            border-color: var(--border-primary);
            color: var(--text-secondary);
        }
        .citation-details {
            margin-top: 10px;
            font-size: 12px;
            border-top: 1px dashed var(--border-secondary);
            padding-top: 8px;
        }
        .citation-details summary {
            cursor: pointer;
            font-weight: normal;
            color: var(--text-secondary);
            list-style: none;
            display: inline-block;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .citation-details summary::-webkit-details-marker { display: none; }
        .citation-details summary::marker { display: none; }
        .citation-details summary:hover {
            text-decoration: underline;
        }
        .citation-list {
            list-style: none;
            padding-left: 0;
            margin-top: 8px;
            margin-bottom: 0;
        }
        .citation-list li {
            margin-bottom: 5px;
            overflow-wrap: break-word;
        }
        .citation-list li a {
            color: var(--text-link);
            text-decoration: none;
            display: block;
        }
        .citation-list li a:hover {
            text-decoration: underline;
        }
        body.dark-mode .citation-details {
            border-top-color: var(--border-primary);
        }
        body.dark-mode .citation-details summary {
            color: var(--text-secondary);
        }
        body.dark-mode .citation-list li a {
            color: var(--text-link);
        }
        body.dark-mode .message-content table,
        body.dark-mode .message-content th,
        body.dark-mode .message-content td {
            border-color: var(--border-primary);
        }
        body.dark-mode .message-content th {
            background-color: var(--bg-secondary);
        }
        body.dark-mode .message-content hr {
            border-top-color: var(--border-primary);
        }
        .attachment-details {
            margin-top: 10px;
            font-size: 12px;
            border: 1px solid var(--border-attachment-details);
            border-radius: 5px;
            background-color: var(--bg-attachment-details);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .attachment-details summary {
            cursor: pointer;
            font-weight: normal;
            color: var(--text-attachment-summary);
            list-style: none;
            padding: 5px 10px;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .attachment-details summary::-webkit-details-marker { display: none; }
        .attachment-details summary::marker { display: none; }
        .attachment-details summary::before {
            content: '📎';
            font-size: 14px;
            display: inline-block;
        }
        .attachment-details[open] summary {
            border-bottom: 1px solid var(--border-attachment-details);
        }
        .attachment-list {
            list-style: none;
            padding: 8px 10px 5px 10px;
            margin: 0;
        }
        .attachment-list li {
            margin-bottom: 4px;
            font-size: 10px;
            color: var(--text-attachment-filename);
            overflow-wrap: break-word;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }

        #fileUploadDialog {
            min-width: 320px;
            max-width: 600px;
            width: 90%;
        }
        .dialog-content {
            margin-bottom: 20px;
        }
        .file-upload-area {
            margin-bottom: 15px;
            text-align: center;
        }
        .file-upload-area .dialog-button {
            padding: 10px 20px;
            font-size: 14px;
        }
        .file-upload-area #select-files-btn {
            background-color: var(--bg-dialog-button-select);
        }
        .file-upload-area #select-files-btn:hover {
            background-color: var(--bg-dialog-button-select-hover);
        }
        #selected-files-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-secondary);
            border-radius: 5px;
            background-color: var(--bg-secondary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .selected-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-dialog-file-item);
            background-color: var(--bg-dialog-file-item);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .selected-file-item:last-child {
            border-bottom: none;
        }
        .selected-file-info {
            flex-grow: 1;
            overflow: hidden;
            margin-right: 10px;
        }
        .selected-file-name {
            display: block;
            font-size: 14px;
            color: var(--text-dialog-file-name);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .selected-file-size {
            display: block;
            font-size: 11px;
            color: var(--text-dialog-file-size);
        }
        .remove-file-btn {
            background-color: var(--bg-button-delete);
            color: var(--text-light);
            border: none;
            border-radius: 15%;
            width: 22px;
            height: 22px;
            min-width: 0 !important;
            font-size: 14px;
            line-height: 1;
            padding: 0;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        body.pastel-yellow-mode .remove-file-btn,
        body.pastel-rainbow-mode .remove-file-btn {
            color: var(--text-light);
        }
        .remove-file-btn:hover {
            background-color: var(--bg-button-delete-hover);
        }
        #file-upload-notice {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 10px;
            text-align: center;
        }
        #fileUploadDialog .dialog-actions {
            margin-top: 20px;
        }
        #fileUploadDialog .dialog-actions #confirm-attach-btn {
            background-color: var(--bg-dialog-button-confirm);
        }
        #fileUploadDialog .dialog-actions #confirm-attach-btn:hover:not(:disabled) {
            background-color: var(--bg-dialog-button-confirm-hover);
        }
        #fileUploadDialog .dialog-actions #cancel-attach-btn {
            background-color: var(--bg-dialog-button-cancel);
        }
        #fileUploadDialog .dialog-actions #cancel-attach-btn:hover:not(:disabled) {
            background-color: var(--bg-button-cancel-hover);
        }
        .orange-button {
            background-color: var(--bg-button-edit);
            color: var(--text-light);
        }
        .orange-button:hover:not(:disabled) {
            background-color: var(--bg-button-edit-hover);
        }
        body.dark-mode .orange-button {
            background-color: var(--bg-button-edit);
            color: var(--text-light);
        }
        body.dark-mode .orange-button:hover:not(:disabled) {
            background-color: var(--bg-button-edit-hover);
        }
        body.pastel-pink-mode .orange-button,
        body.pastel-blue-mode .orange-button,
        body.pastel-yellow-mode .orange-button,
        body.pastel-purple-mode .orange-button,
        body.pastel-rainbow-mode .orange-button {
            background-color: var(--bg-button-edit);
            color: var(--text-light);
        }
        body.pastel-pink-mode .orange-button:hover:not(:disabled),
        body.pastel-blue-mode .orange-button:hover:not(:disabled),
        body.pastel-yellow-mode .orange-button:hover:not(:disabled),
        body.pastel-purple-mode .orange-button:hover:not(:disabled),
        body.pastel-rainbow-mode .orange-button:hover:not(:disabled) {
            background-color: var(--bg-button-edit-hover);
        }
        body.pastel-yellow-mode .orange-button {
            color: #ffffff;
        }
        .danger-zone .orange-button {
            margin-top: 10px;
            width: 100%;
        }
        .interactive-title-content-style {
            margin-left: 3px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .history-item-actions .js-link-session-btn {
        }
        .history-item-actions .js-link-session-btn:hover:not(:disabled) {
            background-color: var(--bg-button-action-hover) !important;
        }
        .history-item-actions .js-link-session-btn.linked-a {
            background-color: var(--bg-button-save) !important;
            color: var(--text-light) !important;
        }
        .history-item-actions .js-link-session-btn.linked-a:hover:not(:disabled) {
            background-color: var(--bg-button-save-hover) !important;
        }
        .history-item-actions .js-link-session-btn.linked-b {
            background-color: var(--bg-button-copy) !important;
            color: var(--text-light) !important;
        }
        .history-item-actions .js-link-session-btn.linked-b:hover:not(:disabled) {
            background-color: var(--bg-button-copy-hover) !important;
        }
        #ai-to-ai-chat-btn {
        }
        .set-thinking-budget-btn {
            flex-grow: 1;
        }

    </style>
    <script src="marked.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" integrity="sha512-3xR29H5yNih58Zl8v2l/NJV92VjSS3WPrT+aXk9O5y6/Yv+yP2OxJ0MDBv7G2yKChx91H2KqU4oQ8J2G7Wl+A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="app-container">

        <div id="chat-screen" class="screen active">
            <header class="app-header">
                <button id="goto-history-btn" class="header-button" aria-label="履歴一覧へ">☰</button>
                <h1 id="chat-title">新規チャット</h1>
                <button id="new-chat-btn" class="new-chat-button" title="新規チャットを開始">新</button>
                <button id="delete-session-btn" class="action-button-in-header" title="現在のチャットを削除">削</button>
                <button id="copy-session-btn" class="action-button-in-header" title="チャット全体をコピー">コ</button>
                <button id="scroll-to-top-btn" class="header-button scroll-jump-button" aria-label="最上部へスクロール" title="最上部へ">🔼</button>
                <button id="scroll-to-bottom-btn" class="header-button scroll-jump-button" aria-label="最下部へスクロール" title="最下部へ">🔽</button>
                <button id="toggle-all-content-btn" class="header-button" aria-label="全メッセージ表示切替" title="全メッセージの表示/非表示を切り替え">🖼️</button>
                <button id="toggle-clipboard-stack-btn" class="header-button" aria-label="クリップボードスタックを開閉">🗒️</button>
                <button id="toggle-memo-btn" class="header-button" aria-label="メモを開閉">📝</button>
                <button id="goto-settings-btn" class="header-button" aria-label="設定へ">⚙</button>
            </header>

            <div id="system-prompt-area-placeholder" style="display:none;"></div>

            <div id="memo-area" class="hidden">
                <div class="memo-actions-container">
                    <button id="delete-memo-btn" class="delete-memo-btn" title="メモの内容を全て削除">全削除</button>
                    <button id="copy-memo-btn" class="copy-memo-btn" title="メモをコピー">コピー</button>
                    <button id="paste-memo-btn" class="paste-memo-btn" title="メモに貼り付け">貼付け</button>
                </div>
                <textarea id="memo-editor" aria-label="メモ入力エリア" placeholder="ここに一時的なメモを入力...（保存されません）"></textarea>
            </div>

            <div id="clipboard-stack-area" class="hidden">
                <div class="clipboard-stack-actions-container">
                    <button id="delete-clipboard-stack-btn" class="delete-clipboard-stack-btn" title="スタックの内容を全て削除">全削除</button>
                    <button id="copy-clipboard-stack-btn" class="copy-clipboard-stack-btn" title="スタック全体をコピー">全コピー</button>
                    <button id="paste-clipboard-stack-btn" class="paste-clipboard-stack-btn" title="スタックに貼り付け">貼付け</button>
                </div>
                <textarea id="clipboard-stack-editor" aria-label="クリップボードスタック入力エリア" placeholder="ここにコピーされたメッセージが蓄積されます...（保存されません）"></textarea>
            </div>

            <main class="main-content">
                <div id="system-prompt-area" class="system-prompt-area">
                    <details id="system-prompt-details">
                        <summary>システムプロンプト</summary>
                        <div class="system-prompt-content">
                            <textarea id="system-prompt-editor" aria-label="システムプロンプト編集"></textarea>
                            <div class="system-prompt-actions">
                                <button id="cancel-system-prompt-btn" class="cancel-system-prompt-btn">キャンセル</button>
                                <button id="save-system-prompt-btn" class="save-system-prompt-btn">保存</button>
                            </div>
                        </div>
                    </details>
                </div>
                <div id="message-container" class="message-container">
                </div>
                <div id="loading-indicator" class="loading-indicator hidden" aria-live="polite">応答中</div>
            </main>
            <footer class="chat-input-area">
                <button id="roll-dice-btn" title="ランダム数値を入力" class="footer-action-button hidden">🎲</button>
                <button id="ai-to-ai-chat-btn" title="AI間会話ステップ実行" class="footer-action-button hidden">👥</button>
                <button id="paste-to-input-btn" title="入力欄に貼り付け" class="footer-action-button">貼</button>
                <textarea id="user-input" placeholder="メッセージを入力..." rows="1" aria-label="メッセージ入力"></textarea>
                <button id="attach-file-btn" title="ファイルを添付" class="footer-action-button">+<span class="attachment-badge"></span></button>
                <button id="send-button" title="送信">送</button>
            </footer>
        </div>

        <div id="history-screen" class="screen">
            <header class="app-header">
                <button id="back-to-chat-from-history" class="header-button" aria-label="チャットへ戻る">＞</button>
                <h1 id="history-title">履歴一覧</h1>

                <button id="export-all-sessions-btn" class="header-save-button history-action-button gold" title="全セッションをJSON形式で出力">全出力</button>

                <button id="import-all-sessions-btn" class="header-save-button history-action-button purple" title="全セッションをJSON形式で取込">全取込</button>
                <input type="file" id="import-all-sessions-input" accept=".json" class="hidden">

                <button id="import-history-btn" class="header-save-button" title="単一履歴をテキスト形式でインポート">インポート</button>
                <input type="file" id="import-history-input" accept=".txt" class="hidden">
            </header>
            <main class="main-content">
                <ul id="history-list" class="history-list">
                    <li class="js-history-item-template history-item">
                        <div class="history-item-details">
                            <span class="history-item-title"></span>
                        </div>
                        <div class="history-item-bottom-row">
                            <div class="history-item-dates">
                                <span class="created-date"></span>
                                <span class="updated-date"></span>
                            </div>
                            <div class="history-item-actions">
                                <button class="js-link-session-btn" title="セッションをリンク/解除" style="font-size: 16px; padding: 6px 8px; background-color: var(--bg-button-action);">🔗</button>
                                <button class="js-edit-title-btn" title="タイトル編集">✎</button>
                                <button class="js-export-btn" title="出力">出力</button>
                                <button class="js-duplicate-btn" title="複製">複製</button>
                                <button class="js-delete-btn" title="削除">削除</button>
                            </div>
                        </div>
                    </li>
                </ul>
                 <p id="no-history-message" class="hidden" style="text-align: center; color: var(--text-secondary); margin-top: 20px;">チャット履歴はありません。</p>
            </main>
        </div>

        <div id="settings-screen" class="screen">
            <header class="app-header">
                 <button id="back-to-chat-from-settings" class="header-button" aria-label="チャットへ戻る">＜</button>
                 <h1>設定</h1>
                 <span id="settings-save-notice" class="header-notice">※反映には保存が必要</span>
                 <button class="js-save-settings-btn header-save-button" title="設定を保存">設定を保存</button>
            </header>
            <main class="main-content">
                <details open class="settings-group" id="settings-group-api-provider">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">APIプロバイダー設定</summary>
                    <div style="margin-top:15px;">
                        <label for="api-provider-select">使用するAPIプロバイダー:</label>
                        <select id="api-provider-select" aria-label="APIプロバイダー選択">
                            <option value="gemini">Google Gemini</option>
                            <option value="deepseek">DeepSeek</option>
                        </select>
                    </div>
                </details>

                <details id="gemini-settings-group" class="settings-group">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">Gemini API 設定</summary>
                    <div style="margin-top:15px;">
                        <label for="gemini-api-key">Gemini APIキー:</label>
                        <input type="password" id="gemini-api-key" placeholder="APIキーを入力" aria-label="Gemini APIキー">

                        <label for="gemini-model-name">モデル名:</label>
                        <select id="gemini-model-name" aria-label="モデル名">
                            <optgroup label="無料">
                                <option value="gemini-2.0-flash">gemini-2.0-flash</option>
                                <option value="gemini-2.5-flash-preview-04-17">gemini-2.5-flash-preview-04-17</option>
                                <option value="gemini-2.5-flash-preview-05-20">gemini-2.5-flash-preview-05-20</option>
                            </optgroup>
                            <optgroup label="有料">
                                <option value="gemini-2.5-pro-preview-03-25">gemini-2.5-pro-preview-03-25</option>
                                <option value="gemini-2.5-pro-preview-05-06">gemini-2.5-pro-preview-05-06</option>
                            </optgroup>
                            <optgroup label="ユーザー指定" id="gemini-user-defined-models-group">
                            </optgroup>
                            <optgroup label="提供終了・使用不可（削除候補）">
                                <option value="gemini-2.5-pro-exp-03-25">gemini-2.5-pro-exp-03-25</option>
                            </optgroup>
                        </select>
                        <label for="gemini-additional-models" style="margin-top:10px;">追加モデル (カンマ区切り):</label>
                        <textarea id="gemini-additional-models" placeholder="例: gemini-2.0-pro,gemini-2.0-flash-lite" aria-label="追加モデル"></textarea>
                    </div>
                </details>

                <details id="deepseek-settings-group" class="settings-group hidden">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">DeepSeek API 設定</summary>
                    <div style="margin-top:15px;">
                        <label for="deepseek-api-key">DeepSeek APIキー:</label>
                        <input type="password" id="deepseek-api-key" placeholder="DeepSeek APIキーを入力" aria-label="DeepSeek APIキー">

                        <label for="deepseek-model-name">DeepSeek モデル名:</label>
                        <select id="deepseek-model-name" aria-label="DeepSeek モデル名">
                            <optgroup label="基本モデル (DeepSeek)">
                                <option value="deepseek-chat">deepseek-chat</option>
                                <option value="deepseek-coder">deepseek-coder</option>
                                <option value="deepseek-reasoner">deepseek-reasoner</option>
                            </optgroup>
                             <optgroup label="ユーザー指定 (DeepSeek)" id="deepseek-user-defined-models-group">
                            </optgroup>
                        </select>
                        <label for="deepseek-additional-models" style="margin-top:10px;">DeepSeek 追加モデル (カンマ区切り):</label>
                        <textarea id="deepseek-additional-models" placeholder="例: custom-model-1,custom-model-2" aria-label="DeepSeek 追加モデル"></textarea>

                        <label for="deepseek-api-endpoint" style="margin-top:10px;">DeepSeek APIエンドポイント (オプション):</label>
                        <input type="text" id="deepseek-api-endpoint" placeholder="例: https://api.deepseek.com" aria-label="DeepSeek APIエンドポイント">
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           ※ 空欄の場合はデフォルト (https://api.deepseek.com) を使用し、パスは `/chat/completions` です。 形式的な実装であり、デバッグしておりません。
                         </p>
                    </div>
                </details>

                <details id="gemini-params-group" class="settings-group">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">パラメータ (Gemini)</summary>
                    <div style="margin-top:15px;">
                        <label for="gemini-system-prompt-default">システムプロンプト (デフォルト):</label>
                        <textarea id="gemini-system-prompt-default" placeholder="例: あなたは親切なアシスタントです。新規チャット作成時に適用されます。" aria-label="Gemini システムプロンプト (デフォルト)"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="gemini-enable-system-prompt-default">
                            このシステムプロンプトを有効にする
                        </label>

                        <div class="param-grid">
                            <div>
                                <label for="gemini-max-tokens">Max Tokens:</label>
                                <input type="number" id="gemini-max-tokens" step="1" min="1" placeholder="例:1024" aria-label="Gemini Max Tokens">
                            </div>
                            <div>
                                <label for="gemini-temperature">Temperature:</label>
                                <input type="number" id="gemini-temperature" step="0.1" min="0" max="2" placeholder="例:0.9(0.0-2.0)" aria-label="Gemini Temperature">
                            </div>
                            <div>
                                <label for="gemini-top-k">Top K:</label>
                                <input type="number" id="gemini-top-k" step="1" min="1" placeholder="例:40(1-40)" aria-label="Gemini Top K">
                            </div>
                            <div>
                                <label for="gemini-top-p">Top P:</label>
                                <input type="number" id="gemini-top-p" step="0.01" min="0" max="1" placeholder="例:0.95(0.0 - 1.0)" aria-label="Gemini Top P">
                            </div>
                        </div>

                        <details id="settings-group-gemini-other-params">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); margin-bottom: 10px; list-style: revert;">その他パラメータ (Gemini)</summary>
                            <div class="param-grid">
                                 <div>
                                    <label for="gemini-presence-penalty">Presence Penalty:</label>
                                    <input type="number" id="gemini-presence-penalty" step="0.1" min="-2.0" max="1.9" placeholder="例:0.0 (-2.0～2.0未満)" aria-label="Gemini Presence Penalty">
                                 </div>
                                 <div>
                                    <label for="gemini-frequency-penalty">Frequency Penalty:</label>
                                    <input type="number" id="gemini-frequency-penalty" step="0.1" min="-2.0" max="1.9" placeholder="例:0.0 (-2.0～2.0未満)" aria-label="Gemini Frequency Penalty">
                                </div>
                            </div>
                            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                                ※ Presence/Frequency Penaltyは一部モデルでは非対応、APIエラーとなる場合あり
                            </p>
                            <p style="height:16px;"></p>
                            <div class="param-grid">
                                <div>
                                    <label for="gemini-thinking-budget">Thinking Budget:</label>
                                    <input type="number" id="gemini-thinking-budget" step="1" min="0" placeholder="例: 5000 (0～24576整数)" aria-label="Gemini Thinking Budget">
                                    <div style="display: flex; gap: 8px; margin-top: 5px; margin-bottom: 10px;">
                                        <button type="button" class="set-thinking-budget-btn" data-value="null" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px; flex-grow:1;">無</button>
                                        <button type="button" class="set-thinking-budget-btn" data-value="0" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px; flex-grow:1;">0</button>
                                        <button type="button" class="set-thinking-budget-btn" data-value="24576" style="padding: 4px 8px; font-size: 12px; background-color: var(--bg-button-action); color: var(--text-light); border-radius:3px; flex-grow:1;">24576</button>
                                    </div>
                                </div>
                            </div>
                            <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                                ※ Thinking Budgetは新しいGeminiモデルのみ対応。0明示でthinkingをOFF。<br>
                                ※ 1～1024指定時は固定で1024になる
                            </p>
                            <div id="gemini-thoughts-param">
                               <label class="checkbox-label" style="margin-top: 15px;">
                                   <input type="checkbox" id="gemini-include-thoughts-toggle">
                                   Include Thoughts
                               </label>
                               <label class="checkbox-label" style="margin-top: -5px;">
                                   <input type="checkbox" id="gemini-expand-thoughts-by-default-toggle">
                                   💭思考プロセスを開いた状態にする
                               </label>
                               <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                   ※ チェック時、モデルの思考プロセスの要約が返る。<br>
                                   ※ thinkingConfigが有効なGeminiモデルでのみ機能。
                               </p>
                           </div>
                        </details>
                    </div>
                </details>

                <details id="deepseek-params-group" class="settings-group hidden">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">パラメータ (DeepSeek)</summary>
                    <div style="margin-top:15px;">
                        <label for="deepseek-system-prompt-default">システムプロンプト (デフォルト):</label>
                        <textarea id="deepseek-system-prompt-default" placeholder="例: あなたは親切なDeepSeekアシスタントです。" aria-label="DeepSeek システムプロンプト (デフォルト)"></textarea>
                        <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                            <input type="checkbox" id="deepseek-enable-system-prompt-default">
                            このシステムプロンプトを有効にする
                        </label>

                        <div class="param-grid">
                            <div>
                                <label for="deepseek-max-tokens">Max Tokens:</label>
                                <input type="number" id="deepseek-max-tokens" step="1" min="1" placeholder="例:1024" aria-label="DeepSeek Max Tokens">
                            </div>
                            <div>
                                <label for="deepseek-temperature">Temperature:</label>
                                <input type="number" id="deepseek-temperature" step="0.1" min="0" max="2" placeholder="例:0.9(0.0-2.0)" aria-label="DeepSeek Temperature">
                            </div>
                            <div>
                                <label for="deepseek-top-p">Top P:</label>
                                <input type="number" id="deepseek-top-p" step="0.01" min="0" max="1" placeholder="例:0.95(0.0 - 1.0)" aria-label="DeepSeek Top P">
                            </div>
                        </div>
                         <details id="settings-group-deepseek-other-params">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); margin-bottom: 10px; list-style: revert;">その他パラメータ (DeepSeek)</summary>
                            <div class="param-grid">
                                 <div>
                                    <label for="deepseek-presence-penalty">Presence Penalty:</label>
                                    <input type="number" id="deepseek-presence-penalty" step="0.1" min="-2.0" max="2.0" placeholder="例:0.0 (-2.0～2.0)" aria-label="DeepSeek Presence Penalty">
                                 </div>
                                 <div>
                                    <label for="deepseek-frequency-penalty">Frequency Penalty:</label>
                                    <input type="number" id="deepseek-frequency-penalty" step="0.1" min="-2.0" max="2.0" placeholder="例:0.0 (-2.0～2.0)" aria-label="DeepSeek Frequency Penalty">
                                </div>
                            </div>
                             <div id="deepseek-thoughts-param">
                               <h3 style="margin-top:15px; margin-bottom:10px; font-size:14px; border:0; padding:0;">思考プロセス</h3>
                               <label class="checkbox-label">
                                   <input type="checkbox" id="deepseek-include-thoughts-toggle">
                                   Include Thoughts
                               </label>
                               <label class="checkbox-label">
                                   <input type="checkbox" id="deepseek-expand-thoughts-by-default-toggle">
                                   💭思考プロセスを開いた状態にする
                               </label>
                               <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                                   ※ deepseek-reasoner モデル等で利用可能。<br>
                               </p>
                           </div>
                        </details>
                    </div>
                </details>

                <details id="gemini-advanced-group" class="settings-group">
                   <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">アドバンスド (Gemini)</summary>
                   <div style="margin-top:15px;">
                       <label for="gemini-dummy-user">ダミー User プロンプト (送信時のみ追加):</label>
                       <textarea id="gemini-dummy-user" placeholder="API送信直前に user ロールとして履歴末尾に追加されます" aria-label="Gemini ダミー User プロンプト"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="gemini-enable-dummy-user">
                           このダミーUserプロンプトを有効にする
                       </label>

                       <label for="gemini-dummy-model">ダミー Model プロンプト (送信時のみ追加):</label>
                       <textarea id="gemini-dummy-model" placeholder="API送信直前に model ロールとして履歴最末尾に追加されます" aria-label="Gemini ダミー Model プロンプト"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px;">
                           <input type="checkbox" id="gemini-enable-dummy-model">
                           このダミーModelプロンプトを有効にする
                       </label>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="gemini-concat-dummy-model">
                           ダミーモデルと回答を連結
                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           ※チェック時、モデル応答の先頭に上記ダミーModelの内容を付与。
                       </p>
                       <hr style="margin: 15px 0;">
                       <label class="checkbox-label">
                           <input type="checkbox" id="gemini-streaming-output">
                           ストリーミング出力を使用する
                       </label>
                       <label for="gemini-streaming-speed">文字送り速度 (ミリ秒/文字):</label>
                       <input type="number" id="gemini-streaming-speed" min="0" step="1" placeholder="例: 30 (0で無効)" aria-label="Gemini 文字送り速度">
                       <div id="gemini-pseudo-streaming-param">
                           <label class="checkbox-label" style="margin-top: 10px;">
                               <input type="checkbox" id="gemini-pseudo-streaming">
                               疑似ストリーミングを使用 (ストリーミングON時のみ有効)
                           </label>
                           <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                               ※実際には一括生成を呼び、応答はストリーミング再生を行う。<br>
                               普通のストリーミングより生成待ち時間は長くなる。
                           </p>
                       </div>
                    </div>
                </details>

                <details id="deepseek-advanced-group" class="settings-group hidden">
                   <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">アドバンスド (DeepSeek)</summary>
                   <div style="margin-top:15px;">
                       <label for="deepseek-dummy-user">ダミー User プロンプト (送信時のみ追加):</label>
                       <textarea id="deepseek-dummy-user" placeholder="API送信直前に user ロールとして履歴末尾に追加されます" aria-label="DeepSeek ダミー User プロンプト"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="deepseek-enable-dummy-user">
                           このダミーUserプロンプトを有効にする
                       </label>

                       <label for="deepseek-dummy-model">ダミー Model プロンプト (送信時のみ追加):</label>
                       <textarea id="deepseek-dummy-model" placeholder="API送信直前に model ロールとして履歴最末尾に追加されます" aria-label="DeepSeek ダミー Model プロンプト"></textarea>
                       <label class="checkbox-label" style="margin-top: -5px;">
                           <input type="checkbox" id="deepseek-enable-dummy-model">
                           このダミーModelプロンプトを有効にする
                       </label>
                       <label class="checkbox-label" style="margin-top: -5px; margin-bottom: 15px;">
                           <input type="checkbox" id="deepseek-concat-dummy-model">
                           ダミーモデルと回答を連結
                       </label>
                       <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                           ※チェック時、モデル応答の先頭に上記ダミーModelの内容を付与。
                       </p>
                       <hr style="margin: 15px 0;">
                       <label class="checkbox-label">
                           <input type="checkbox" id="deepseek-streaming-output">
                           ストリーミング出力を使用する
                       </label>
                       <label for="deepseek-streaming-speed">文字送り速度 (ミリ秒/文字):</label>
                       <input type="number" id="deepseek-streaming-speed" min="0" step="1" placeholder="例: 30 (0で無効)" aria-label="DeepSeek 文字送り速度">
                    </div>
                </details>


                <div id="gemini-grounding-param" class="settings-group">
                    <h3>検索 (Gemini)</h3>
                    <label class="checkbox-label">
                        <input type="checkbox" id="gemini-enable-grounding-toggle">
                        ネットから情報を取得させる (Google Search)
                    </label>
                    <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                        ※ チェック時、モデルは回答生成のためにWeb検索を行う。<br>
                        ※ Gemini 2.0以降でのみ対応(1.5以前は互換なし。エラーになる)<br>
                        ※ 推論モデルは推論内で検索する場合があり、引用データが帰らない場合がある。
                    </p>
                </div>
                <div class="settings-group" id="settings-group-image">
                    <h3>イメージ画像</h3>
                    <label>チャット画面の背景画像:</label>
                    <div class="image-upload-controls">
                        <input type="file" id="background-image-input" accept="image/jpeg, image/png, image/gif, image/webp" class="hidden">
                        <button id="upload-background-btn" class="settings-action-button" type="button">画像を選択...</button>
                        <img id="background-thumbnail" src="" alt="背景画像プレビュー" class="background-thumbnail hidden">
                        <button id="delete-background-btn" class="settings-delete-button hidden" type="button">画像を削除</button>
                    </div>
                     <p style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                       ※ 画像はブラウザ内のデータベースに保存。<br>
                       ※ 可読性のため画像の上に半透明のレイヤーを表示。
                     </p>
                </div>

                <details class="settings-group" id="settings-group-icons">
                    <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">チャットアイコン設定</summary>
                    <div style="margin-top:15px;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="show-user-icon-toggle">
                            ユーザーアイコンを表示する
                        </label>
                        <div class="image-upload-controls" style="margin-bottom: 5px;">
                            <input type="file" id="user-icon-input" accept="image/jpeg, image/png, image/gif, image/webp" class="hidden">
                            <button id="upload-user-icon-btn" class="settings-action-button" type="button">ユーザーアイコン選択...</button>
                            <img id="user-icon-thumbnail" src="" alt="ユーザーアイコンプレビュー" class="icon-thumbnail hidden">
                            <button id="delete-user-icon-btn" class="settings-delete-button hidden" type="button">削除</button>
                        </div>
                        <label class="checkbox-label" style="margin-top: 5px;">
                            <input type="checkbox" id="show-user-name-toggle">
                            ユーザー名を表示する
                        </label>
                        <label for="user-name-input">表示するユーザー名:</label>
                        <input type="text" id="user-name-input" placeholder="例: あなた" aria-label="表示するユーザー名">


                        <label class="checkbox-label" style="margin-top: 20px;">
                            <input type="checkbox" id="show-ai-icon-toggle">
                            AIアイコンを表示する
                        </label>
                        <div class="image-upload-controls" style="margin-bottom: 5px;">
                            <input type="file" id="ai-icon-input" accept="image/jpeg, image/png, image/gif, image/webp" class="hidden">
                            <button id="upload-ai-icon-btn" class="settings-action-button" type="button">AIアイコン選択...</button>
                            <img id="ai-icon-thumbnail" src="" alt="AIアイコンプレビュー" class="icon-thumbnail hidden">
                            <button id="delete-ai-icon-btn" class="settings-delete-button hidden" type="button">削除</button>
                        </div>
                        <label class="checkbox-label" style="margin-top: 5px;">
                            <input type="checkbox" id="show-ai-name-toggle">
                            AI名を表示する
                        </label>
                        <label for="ai-name-input">表示するAI名:</label>
                        <input type="text" id="ai-name-input" placeholder="例: Gemini" aria-label="表示するAI名">

                        <details id="settings-group-icon-details">
                            <summary style="cursor: pointer; font-weight: normal; font-size: 14px; color: var(--text-link); list-style: revert;">アイコン表示調整</summary>
                            <div style="padding-left: 15px; margin-top: 10px;">
                                <div style="margin-top: 10px;">
                                    <label for="icon-name-font-size">アイコン下の名前の文字サイズ (px):</label>
                                    <input type="number" id="icon-name-font-size" min="1" max="46" step="1" placeholder="例: 10" aria-label="アイコン下の名前の文字サイズ（上限あり）">
                                </div>
                                <div style="margin-top: 10px;">
                                    <label for="icon-name-offset-y">名前の垂直オフセット (px, 上が正):</label>
                                    <input type="number" id="icon-name-offset-y" step="1" placeholder="例: 10" aria-label="名前の垂直オフセット（上限あり）">
                                </div>
                                <div style="margin-top: 20px;">
                                    <label for="message-icon-size">アイコン表示サイズ (px):</label>
                                    <input type="number" id="message-icon-size" min="1" max="300" step="1" placeholder="例: 28" aria-label="アイコン表示サイズ（上限あり）">
                                </div>
                                <div style="margin-top: 15px;">
                                    <label for="message-icon-offset-y">アイコン垂直オフセット (px, 上が正):</label>
                                    <input type="number" id="message-icon-offset-y" step="1" placeholder="例: 0 (上下に調整)" aria-label="アイコン垂直オフセット（上限あり）">
                                </div>
                                <hr style="margin: 20px 0;">
                                <h4>ユーザー名の背景バブル</h4>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-name-bubble-toggle">
                                    バブルを表示する
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="user-name-bubble-use-theme-color-toggle">
                                    テーマのメッセージ色に合わせる
                                </label>
                                <div id="user-name-bubble-custom-color-settings">
                                    <label for="user-name-bubble-color">背景色 (上記OFF時):</label>
                                    <input type="text" id="user-name-bubble-color" placeholder="#FFFFFF">
                                </div>
                                <label for="user-name-bubble-opacity">透過度 (0.0-1.0):</label>
                                <input type="number" id="user-name-bubble-opacity" min="0" max="1" step="0.1" placeholder="0.8">

                                <h4 style="margin-top: 15px;">AI名の背景バブル</h4>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="ai-name-bubble-toggle">
                                    バブルを表示する
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="ai-name-bubble-use-theme-color-toggle">
                                    テーマのメッセージ色に合わせる
                                </label>
                                <div id="ai-name-bubble-custom-color-settings">
                                    <label for="ai-name-bubble-color">背景色 (上記OFF時):</label>
                                    <input type="text" id="ai-name-bubble-color" placeholder="#FFFFFF">
                                </div>
                                <label for="ai-name-bubble-opacity">透過度 (0.0-1.0):</label>
                                <input type="number" id="ai-name-bubble-opacity" min="0" max="1" step="0.1" placeholder="0.8">
                            </div>
                         </details>
                         <p style="font-size: 11px; color: var(--text-secondary); margin-top: 15px;">
                           ※ アイコン画像はブラウザ内のデータベースに保存されます。<br>
                           ※ 表示時は円形に切り取られます。デフォルトサイズ: 28px。
                         </p>
                    </div>
                </details>

                <div class="settings-group" id="settings-group-other">
                   <details open id="settings-group-other-details">
                        <summary style="font-size: 16px; color: var(--text-link); border-bottom: 1px solid var(--border-tertiary); padding-bottom: 5px; margin-bottom: 15px; display: list-item; list-style: revert; cursor:pointer; font-weight: bold;">その他設定</summary>
                        <div style="margin-top:15px;">
                           <label class="checkbox-label">
                               <input type="checkbox" id="enter-to-send">
                               Enterキーで送信する
                           </label>
                           <label class="checkbox-label">
                               <input type="checkbox" id="auto-scroll-on-new-message">
                               メッセージ送受信時に自動スクロールする
                           </label>
                           <label class="checkbox-label">
                               <input type="checkbox" id="auto-scroll-on-thought">
                               思考プロセス受信時に自動スクロールする
                           </label>
                           <p style="height:10px"></p>
                           <label class="checkbox-label">
                               <input type="checkbox" id="swipe-navigation-toggle">
                               チャット画面から左右スワイプで画面移動
                           </label>
                           <label class="checkbox-label">
                               <input type="checkbox" id="prevent-zoom-toggle">
                               ズームを禁止する (テキスト入力時の自動ズーム防止)
                           </label>
                           <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                               ※ スマホ等でテキスト入力時に意図せずズームするのを防ぎます。
                           </p>
                           <label class="checkbox-label">
                                <input type="checkbox" id="show-paste-button-in-edit-toggle">
                                メッセージ編集ツールバーに「貼付け」ボタンを表示する
                            </label>
                            <p style="height:10px"></p>
                            <label class="checkbox-label">
                                <input type="checkbox" id="disable-retry-confirmation-toggle">
                                リトライ時の確認ダイアログを無効にする
                            </label>
                           <p style="height:10px"></p>
                           <label class="checkbox-label">
                               <input type="checkbox" id="disable-delete-message-confirmation-toggle">
                               メッセージ削除時の確認ダイアログを無効にする
                           </label>
                           <label class="checkbox-label">
                               <input type="checkbox" id="enable-input-while-sending">
                               応答中でもメッセージ入力を可能にする (非推奨)
                           </label>
                           <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                               ※ 通常、応答中は入力できませんが、このオプションで可能になります。
                           </p>
                           <p style="height:10px"></p>
                           <label for="theme-select">表示テーマ:</label>
                           <select id="theme-select" aria-label="表示テーマ">
                               <option value="light">ライトモード</option>
                               <option value="dark">ダークモード</option>
                               <option value="pastel-pink">パステルモード🩷</option>
                               <option value="pastel-blue">パステルモード🩵</option>
                               <option value="pastel-yellow">パステルモード🟡</option>
                               <option value="pastel-purple">パステルモード🟣</option>
                               <option value="pastel-rainbow">パステルモード🌈</option>
                           </select>
                           <p style="height:10px"></p>
                           <details id="settings-group-header-footer-buttons">
                                <summary style="font-size: 14px; color: var(--text-link); padding-bottom: 5px; margin-bottom: 10px; display: list-item; list-style: revert; cursor:pointer; font-weight: normal;">ヘッダー/フッターボタン表示設定</summary>
                                <div style="padding-top:10px; padding-left:15px;">
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-chat-title-toggle">
                                       ヘッダーにチャットタイトルを表示する
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-new-chat-button-toggle">
                                       ヘッダーに「新規」ボタンを表示する（「新」ボタン）
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-delete-session-button-toggle">
                                       ヘッダーに「全削除」ボタンを表示する（「削」ボタン）
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-copy-session-button-toggle">
                                       ヘッダーに「全コピー」ボタンを表示する（「コ」ボタン）
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-scroll-to-top-button-toggle">
                                       ヘッダーに「最上部へ(🔼)」ボタンを表示する
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-scroll-to-bottom-button-toggle">
                                       ヘッダーに「最下部へ(🔽)」ボタンを表示する
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-toggle-all-content-button-toggle">
                                       ヘッダーに「全表示/非表示(🖼️)」ボタンを表示する
                                   </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="show-memo-button-toggle">
                                        ヘッダーにメモボタン(📝)を表示する
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="show-clipboard-stack-button-toggle">
                                        ヘッダーにクリップボードスタックボタン(🗒️)を表示する
                                    </label>
                                    <div>
                                        <label for="memo-height">メモ・スタック・固定プロンプトの縦の幅 (例: 200px, 30vh):</label>
                                        <input type="text" id="memo-height" placeholder="例: 200px, 30vh" aria-label="メモ・スタック・固定プロンプトの縦の幅">
                                    </div>
                                    <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom:10px;">
                                        ※ 各エリアは縦方向にリサイズ可能です。
                                    </p>
                                   <label class="checkbox-label">
                                        <input type="checkbox" id="show-bulk-history-actions-toggle">
                                        履歴画面に「全出力」「全取込」ボタンを表示する
                                    </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-paste-button-in-footer-toggle">
                                       フッターに「貼付け」ボタンを表示する
                                   </label>
                                   <label class="checkbox-label">
                                       <input type="checkbox" id="show-dice-button-toggle">
                                       フッターにダイスボタン(🎲)を表示する
                                   </label>
                                    <div id="dice-value-settings" class="hidden" style="margin-top:5px;">
                                        <div class="param-grid">
                                            <div>
                                                <label for="dice-min-value">ダイス最小値:</label>
                                                <input type="number" id="dice-min-value" min="0" step="1" placeholder="例: 1">
                                            </div>
                                            <div>
                                                <label for="dice-max-value">ダイス最大値:</label>
                                                <input type="number" id="dice-max-value" min="0" step="1" placeholder="例: 100">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p style="font-size: 11px; color: var(--text-secondary); margin-top: 5px; margin-bottom: 10px; padding-left:15px;">
                                   ※ 以上のボタン類は必要な物のみオンにしてください。（ヘッダーを圧迫し⚙ボタンが画面から溢れ、“チャット画面から左右スワイプで画面移動”オプションもオフにしている場合、設定画面に入れなくなる恐れがあります）
                                </p>
                           </details>
                           <p style="height:10px"></p>
                           <label class="checkbox-label">
                               <input type="checkbox" id="sticky-system-prompt-toggle">
                               システムプロンプトをヘッダーに固定表示する
                           </label>
                           <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                               ※ 有効時、システムプロンプト欄がヘッダー下に固定され、メモ欄等と同様のスタイルになります。
                           </p>
                           <label class="checkbox-label">
                               <input type="checkbox" id="hide-system-prompt-toggle">
                               システムプロンプト非表示
                           </label>
                           <p style="font-size: 11px; color: var(--text-secondary); margin-top: -5px; margin-bottom: 10px;">
                               ※ 没入感を高めたい場合に。非表示でも機能は有効。
                           </p>
                            <label class="checkbox-label">
                               <input type="checkbox" id="show-top-collapse-button-toggle">
                               メッセージ右上に折りたたみボタンを表示する
                           </label>
                            <label class="checkbox-label">
                               <input type="checkbox" id="show-bottom-collapse-button-toggle">
                               メッセージツールバーに折りたたみボタンを表示する
                           </label>
                           <details id="settings-group-collapse-button-details">
